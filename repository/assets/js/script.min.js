$((function(){var filemanager=$(".filemanager"),breadcrumbs=$(".breadcrumbs"),fileList=filemanager.find(".data");ouvrir=function(url){window.opener?window.opener.QCMeditors.loadFile(encodeURI("repository/"+url),!0):location.href="https://qcmcam.net/?url="+encodeURI("repository/"+url)},readData=function(data){var response=[data],currentPath="",breadcrumbsUrls=[],folders=[],files=[];function goto(hash){if((hash=decodeURIComponent(hash).slice(1).split("=")).length){var rendered="";"search"===hash[0]?(filemanager.addClass("searching"),(rendered=searchData(response,hash[1].toLowerCase())).length?(currentPath=hash[0],render(rendered)):render(rendered)):hash[0].trim().length?((rendered=searchByPath(hash[0])).length,currentPath=hash[0],breadcrumbsUrls=generateBreadcrumbs(hash[0]),render(rendered)):(currentPath=data.path,breadcrumbsUrls.push(data.path),render(searchByPath(data.path)))}}function generateBreadcrumbs(nextDir){for(var path=nextDir.split("/").slice(0),i=1;i<path.length;i++)path[i]=path[i-1]+"/"+path[i];return path}function searchByPath(dir){for(var path=dir.split("/"),demo=response,flag=0,i=0;i<path.length;i++)for(var j=0;j<demo.length;j++)if(demo[j].name===path[i]){flag=1,demo=demo[j].items;break}return demo=flag?demo:[]}function searchData(data,searchTerms){return data.forEach((function(d){"folder"===d.type?(searchData(d.items,searchTerms),d.name.toLowerCase().match(searchTerms)&&folders.push(d)):"file"===d.type&&(d.name.toLowerCase().match(searchTerms)?files.push(d):d.desc.toLowerCase().match(searchTerms)&&files.push(d))})),{folders:folders,files:files}}function render(data){var scannedFolders=[],scannedFiles=[];Array.isArray(data)?data.forEach((function(d){"folder"===d.type?scannedFolders.push(d):"file"===d.type&&scannedFiles.push(d)})):"object"==typeof data&&(scannedFolders=data.folders,scannedFiles=data.files),fileList.empty().hide(),scannedFolders.length||scannedFiles.length?filemanager.find(".nothingfound").hide():filemanager.find(".nothingfound").show(),scannedFolders.length&&scannedFolders.forEach((function(f){var itemsLength=f.items.length,name=escapeHTML(f.name),icon='<span class="icon folder"></span>',folder;itemsLength&&(icon='<span class="icon folder full"></span>'),1==itemsLength?itemsLength+=" fichier":itemsLength>1?itemsLength+=" fichiers":itemsLength="Vide",$('<li class="folders"><a href="'+f.path+'" title="'+f.path+'" class="folders">'+icon+'<span class="name">'+name+'</span> <span class="details">'+itemsLength+"</span></a></li>").appendTo(fileList)})),scannedFiles.length&&scannedFiles.forEach((function(f){var fileSize=bytesToSize(f.size),name=escapeHTML(f.name),fileType=name.split("."),descriptif=f.desc,icon='<span class="icon file"></span>',file;icon='<span class="icon file f-'+(fileType=fileType[fileType.length-1])+'">.'+fileType+"</span>",$('<li class="files"><section title="'+f.path+'" class="files" onclick="ouvrir(\''+f.path.replace("'","\\'")+"');\">"+icon+'<span class="name">'+name+'</span> <span class="details">'+fileSize+'</span><span class="descriptif">'+descriptif+"</span></section></li>").appendTo(fileList)}));var url="";filemanager.hasClass("searching")?(url="<span>Résultats de la recherche : </span>",fileList.removeClass("animated")):(fileList.addClass("animated"),breadcrumbsUrls.forEach((function(u,i){var name=u.split("/");i!==breadcrumbsUrls.length-1?url+='<a href="'+u+'"><span class="folderName">'+name[name.length-1]+'</span></a> <span class="arrow">→</span> ':url+='<span class="folderName">'+name[name.length-1]+"</span>"}))),breadcrumbs.text("").append(url),fileList.animate({display:"inline-block"})}function escapeHTML(text){return text.replace(/\&/g,"&amp;").replace(/\</g,"&lt;").replace(/\>/g,"&gt;")}function bytesToSize(bytes){var sizes=["Bytes","KB","MB","GB","TB"];if(0==bytes)return"0 Bytes";var i=parseInt(Math.floor(Math.log(bytes)/Math.log(1024)));return Math.round(bytes/Math.pow(1024,i),2)+" "+sizes[i]}$(window).on("hashchange",(function(){goto(window.location.hash)})).trigger("hashchange"),filemanager.find(".search").click((function(){var search=$(this);search.find("span").hide(),search.find("input[type=search]").show().focus()})),filemanager.find("input").on("input",(function(e){folders=[],files=[];var value=this.value.trim();value.length?(filemanager.addClass("searching"),window.location.hash="search="+value.trim()):(filemanager.removeClass("searching"),window.location.hash=encodeURIComponent(currentPath))})).on("keyup",(function(e){var search=$(this);27==e.keyCode&&search.trigger("focusout")})).focusout((function(e){var search=$(this);search.val().trim().length||(window.location.hash=encodeURIComponent(currentPath),search.hide(),search.parent().find("span").show())})),fileList.on("click","li.folders",(function(e){e.preventDefault();var nextDir=$(this).find("a.folders").attr("href");filemanager.hasClass("searching")?(breadcrumbsUrls=generateBreadcrumbs(nextDir),filemanager.removeClass("searching"),filemanager.find("input[type=search]").val("").hide(),filemanager.find("span").show()):breadcrumbsUrls.push(nextDir),window.location.hash=encodeURIComponent(nextDir),currentPath=nextDir})),breadcrumbs.on("click","a",(function(e){e.preventDefault();var index=breadcrumbs.find("a").index($(this)),nextDir=breadcrumbsUrls[index];breadcrumbsUrls.length=Number(index),window.location.hash=encodeURIComponent(nextDir)}))},loadFile=function(){$("#invisible").load("arbo.json",(function(){readData(JSON.parse($("#invisible").html()))}))},$.ajax({url:"arbo.json",success:readData,error:loadFile})}));