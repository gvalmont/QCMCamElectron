"use strict";CKEDITOR.disableAutoInline=!0;var lang=navigator.language||navigator.userLanguage;lang=lang.substring(0,2);var reponses={0:"C",1:"D",2:"A",3:"B"},nbQ=1,editor,detector,liendirect,myWindow,reponseAction,wait={nexted:!1,updateClasse:!1,addQuestion:!1},usersChangeDetected=!1,reponsesChangeDetected=!1,changeQuestionFocus=!1,changeNombreQuestions=!1,stopSessionRequest=!1,stylesheets={},validrep={},datas={},datasdemo={},qdatas={},qreponses={},totaux={A:0,B:0,C:0,D:0},scan=!1,namesvisible=!0,reponseSimple=!0,correspondances={p5:{743:1,878:1,366:2,741:2,735:3,990:3,734:4,478:5,733:5,727:6,862:6,350:7,725:7,719:8,974:8,590:9,710:9,314:10,689:10,246:11,636:11,635:12,950:12,438:13,633:13,374:14,629:14,118:15,628:15,627:16,822:16,486:17,621:17,619:18,934:18,422:19,617:19,358:20,613:20,607:21,982:21,406:22,601:22,595:23,790:23,454:24,589:24,583:25,838:25,326:26,581:26,498:27,573:27,434:28,569:28,370:29,565:29,443:30,978:30,466:31,541:31,535:32,850:32,509:33,507:34,957:34,189:35,504:35,445:36,505:36,502:37,637:37,381:38,501:38,495:39,1005:39,494:40,749:40,491:41,941:41,237:42,492:42,487:43,877:43,365:44,485:44,150:45,600:45},p4:{106:1,107:2,110:3,111:4,122:5,123:6,126:7,127:8,142:16,154:9,155:10,158:11,159:12,166:13,167:14,169:15,170:16,171:17,173:18,174:19,175:20,182:21,183:22,185:23,186:24,187:25,189:26,190:27,191:28,218:29,219:30,222:31,223:32,230:33,231:34,233:35,234:36,235:37,237:38,238:39,239:40,246:41,247:42,249:43,250:44,251:45,254:46,43:47,46:48,47:49,58:50,59:51,62:52,91:53,94:54,102:55,103:56,105:57,109:58,118:59,121:60,42:61,63:62,90:63,95:64,119:65,125:66,138:67,139:68,217:69,143:70,150:71,151:72,153:73,157:74,162:75,163:76,165:77,168:78,172:79,178:80,179:81,181:82,184:83,188:84,202:85,203:86,206:87,207:88,214:89,215:90},p3:{1:1,2:2,4:3,5:4,6:5,7:6,8:7,10:8,11:9,13:10,16:11,17:12,18:13,19:14,20:15,21:16,27:17,28:18,30:19,32:20,33:21,34:22,35:23,36:24,38:25,39:26,40:27,42:28,45:29,49:30,50:31,52:32,54:33,55:34,56:35,57:36,59:37}},typeCode=4,corres=correspondances["p"+typeCode],qexport="";function lancerDemo(){var intro=introJs();intro.onbeforechange((function(targetElement){var btnclick=["btnadd","btnkey","btna","btnb","btng","btnop"],tb=["A","B","C","D"],alea;if("classes"===targetElement.id)targetElement.value="GP1",users.setGroup("GP1");else if("goodAnswer"===targetElement.id)alea=Math.floor(4*Math.random()),targetElement.value="C",answers.setGoodAnswer("C");else if(btnclick.indexOf(targetElement.id)>-1&&(targetElement.click(),"btna"===targetElement.id&&!0===scan)){var i=0;for(i=1;i<=30;i++)alea=Math.floor(4*Math.random()),datasdemo[i]={vote:tb[alea],nbvotes:1},datas=datasdemo,answers.updateVotes(),answers.compteValeurs(),qdatas[QCMeditors.qFocusOn]=Object.assign({},datas)}})),intro.onchange((function(tElem){if("questionsContener"===tElem.id){setTimeout((function(){CKEDITOR.instances["editor"+QCMeditors.qFocusOn].setData("<h2>Combien font 8×7 ?</h2><p>A. 87</p><p>B. 54</p><p>C. 56</p><p>D. 63")}),1e3);for(let i=1;i<=30;i++){let alea=Math.floor(4*Math.random());datasdemo[i]={vote:["A","B","C","D"][alea],nbvotes:1}}datas=Object.assign({},datasdemo),qreponses[QCMeditors.qFocusOn]=["A","B","C","D"][Math.floor(4*Math.random())]}"btnadd"===tElem.id&&setTimeout((function(){CKEDITOR.instances["editor"+QCMeditors.qFocusOn].setData('<h3>Quel est l&#39;inverse de <span class="math-tex">\\dfrac37</span> ?</h3><p>A.&nbsp;<span class="math-tex">-\\dfrac37</span></p><p>B.&nbsp;<span class="math-tex">-\\dfrac73</span></p><p>C.&nbsp;<span class="math-tex">\\dfrac73</span></p><p>D.&nbsp;<span class="math-tex">\\dfrac{1}{\\dfrac73}</span></p>')}),1500)})),intro.onafterchange((function(tElem){"btnop"===tElem.id&&document.getElementById("btng").click()})),intro.setOptions({skipLabel:"stop",doneLabel:"Compris",nextLabel:" > ",prevLabel:" < ",steps:[{intro:"Par où commencer ?"},{intro:"Distribuez les cartes réponses aléatoirement"},{element:"#classes",intro:"Chargez une classe factice de 30 participants"},{element:"#questionsContener",intro:"Editez rapidement la question"},{element:"#btnadd",intro:"Ajoutez éventuellement des questions"},{element:"#btnkey",intro:"Allumez la caméra"},{element:"#btna",intro:"Activez le scan des réponses et sondez les participants avec votre caméra"},{element:"#btna",intro:"Désactivez le scan des réponses."},{element:"#btnb",intro:"Affichez les statistiques des réponses"},{element:"#goodAnswer",intro:"Indiquez la bonne réponse"},{element:"#btnb",intro:"Montrez les réponses apportées par chacun. Et voilà !"},{intro:"Pour aller plus loin"},{element:"#btng",intro:"Utilisez ce boutons pour afficher plus d'options sur les questions"},{element:"#editionQuestions",intro:"insérez, déplacez les questions, supprimez, téléchargez vos questions, indiquez la bonne réponse..."},{element:"#btng",intro:"Cliquez à nouveau pour fermer."},{element:"#btnop",intro:"ou celui-ci pour les participants"},{element:"#editionParticipants",intro:"Videz, créez, supprimez, éditez, téléchargez les participants"},{element:"#btnop",intro:"Cliquez à nouveau pour fermer."},{element:"#btnstats",intro:"Cliquez pour voir les stats et les télécharger"},{intro:"Ya plus qu'à ... !"}]}),intro.start()}function createFakeScores(nb){let tb=["A","B","C","D"];nbQ=nb,qreponses={},qdatas={},datas={};for(let j=0;j<nb;j++){for(let i=1;i<=30;i++){let alea=Math.floor(4*Math.random());datasdemo[i]={vote:tb[alea],nbvotes:1}}0==j?datas=Object.assign({},datasdemo):qdatas[j]=Object.assign({},datasdemo),qreponses[j]=tb[Math.floor(4*Math.random())]}}var QCMeditors={fileJustLoaded:!1,doRenderKatex:!1,qFocusOn:0,interval:null,animation:!1,reload:[],checkboxes:{},times:[],editable:!0,setEditable:function(yn){for(var elts=document.querySelectorAll("#animate .question"),i=0;i<elts.length;i++)elts[i].contentEditable=yn},setEditableTrue:function(){QCMeditors.setEditable(!0)},unloadCKEDITOR:function(doKatexRender,reload){if(utils.isEmpty(CKEDITOR.instances))return!1;var name;this.doRenderKatex=void 0===doKatexRender||doKatexRender;var listequestions=[];for(name in CKEDITOR.instances)void 0!==reload&&QCMeditors.reload.push(name),void 0===reload&&listequestions.push(CKEDITOR.instances[name].getData()),CKEDITOR.instances[name].destroy(!0);if(void 0===reload){for(var i=0;i<listequestions.length;i++)document.getElementById("editor"+i).innerHTML=listequestions[i],utils.renderKatex("editor"+i);QCMeditors.setEditable(!1),QCMeditors.fileJustLoaded=!0,utils.renderCode()}this.editable=!1},loadCKEDITOR:function(editor){if(QCMeditors.fileJustLoaded&&(utils.revertKatex("animate"),utils.revertHighlight("animate"),QCMeditors.fileJustLoaded=!1),"string"==typeof editor)void 0===CKEDITOR.instances[editor]&&(CKEDITOR.inline(editor),CKEDITOR.instances[editor].on("instanceReady",(function(){QCMeditors.updateCheckAnwers(editor)})),CKEDITOR.instances[editor].on("instanceDestroyed",(function(){QCMeditors.afterDestroy(editor)})),CKEDITOR.instances[editor].on("change",(function(){QCMeditors.updateCheckAnwers(editor)})));else{var i,editors=document.querySelectorAll("#animate > .question");for(i=0;i<editors.length;i++)void 0===CKEDITOR.instances["editor"+i]&&(CKEDITOR.inline(editors[i]),CKEDITOR.instances["editor"+i].on("instanceReady",(function(){QCMeditors.updateCheckAnwers(this.name)})),CKEDITOR.instances["editor"+i].on("instanceDestroyed",(function(){QCMeditors.afterDestroy(this.name)})),CKEDITOR.instances["editor"+i].on("change",(function(){QCMeditors.updateCheckAnwers(this.name)})))}QCMeditors.setEditable(!0),this.editable=!0},reloadCKEDITOR:function(){QCMeditors.unloadCKEDITOR(!1,!0),this.editable=!0,setTimeout(QCMeditors.loadCKEDITOR,500)},afterDestroy:function(editor){this.doRenderKatex&&(utils.renderKatex(editor),QCMeditors.setEditable(!1),this.editable=!1),this.reload.indexOf(editor)>-1&&(QCMeditors.loadCKEDITOR(editor),utils.removeElement(this.reload,editor))},updateCheckAnwers:function(editorID){var childs=document.querySelectorAll("#"+editorID+" ol > li"),elt=document.getElementById("btnchck"),lettres=["A","B","C","D"],check="",type="";elt.innerHTML="";for(var i=0;i<Math.min(4,childs.length);i++)check=void 0!==qreponses[QCMeditors.qFocusOn]&&qreponses[QCMeditors.qFocusOn].indexOf(lettres[i])>-1?' checked="checked" ':"",type=reponseSimple?"radio":"checkbox",elt.innerHTML+='<input type="'+type+'" name="reponse" value="'+lettres[i]+'" id="R'+lettres[i]+'" onclick="answers.setAnswer(this.value,this.type);"'+check+" />"+lettres[i],childs[i].removeEventListener("click",QCMeditors.checkAnswer),childs[i].addEventListener("click",QCMeditors.checkAnswer,!0)},checkAnswer:function(evt){if("ol"!=evt.target.parentNode.nodeName.toLowerCase()||"li"!=evt.target.nodeName.toLowerCase())return!1;let deltax=0,imgBox,objBox=evt.target.getBoundingClientRect(),elt=null,imgOutOL=!0,first=!0,offset=objBox.left,sizeIndex=parseInt(window.getComputedStyle(evt.target,":before").width),imgs=document.querySelectorAll("#editor"+QCMeditors.qFocusOn+" img");for(let i=0;i<imgs.length;i++)if(imgBox=imgs[i].getBoundingClientRect(),imgBox.left<=offset&&objBox.bottom>imgBox.top&&imgBox.bottom>objBox.top){imgBox.width>deltax&&(deltax+=imgBox.width),elt=imgs[i].parentElement;for(let j=0;j<3;j++)if(elt=elt.parentElement,"li"===elt.nodeName.toLocaleLowerCase()){deltax+=first?offset:0,first=!1,imgOutOL=!1;break}imgOutOL&&(deltax+=first?sizeIndex:0),first=!1}let lettres=["A","B","C","D"],x=evt.clientX,tableIsPresent,value;if(null===document.querySelector("#editor"+QCMeditors.qFocusOn+" table li"))value=Array.prototype.indexOf.call(evt.target.parentNode.children,evt.target);else{let cellsTable=document.querySelectorAll("#editor"+QCMeditors.qFocusOn+" table li"),i=0;for(let len=cellsTable.length;i<len&&cellsTable[i]!==evt.target;i++);value=i}let checkboxradio=document.getElementById("R"+lettres[value]);x-30-(deltax||offset)<0&&checkboxradio.click()},setAnimationWidth:function(){this.setQuestionsWidth(),this.updatenbQ(),document.getElementById("animate").style.width=100*nbQ+"%",document.getElementById("animate").style.marginLeft=100*-QCMeditors.qFocusOn+"%"},updatenbQ:function(){var elem=document.getElementById("animate");nbQ=elem.childElementCount},renameEditors:function(rang){var e;if(void 0!==rang)for(var i=nbQ-1;i>=rang;i--)(e=document.getElementById("editor"+i)).id="editor"+(i+1);else{for(var alldivs=document.querySelectorAll("#animate > div"),i=0;i<alldivs.length;i++)alldivs[i].id="editor"+i;this.reloadCKEDITOR()}},addQ:function(){var elem;document.getElementById("animate").innerHTML+='<div id="editor'+nbQ+'" contenteditable="true" class="question"><h3>Question '+(nbQ+1)+"&nbsp;:</h3> <ol><li>&nbsp;</li></ol></div>",this.setAnimationWidth(),this.reloadCKEDITOR(),this.myMove("last"),qdatas[nbQ-1]={},(comm.sessionId||!1!==comm.peerId)&&(changeNombreQuestions=!0)},prevQ:function(){0!==QCMeditors.qFocusOn&&this.myMove("r")},nextQ:function(){var cache;"cache"===document.getElementById("cacheQuestions").className?QCMeditors.qFocusOn!==nbQ-1&&this.myMove("l"):QCMeditors.toggleCacheQuestions()},firstQ:function(){0!==QCMeditors.qFocusOn&&this.myMove("first")},lastQ:function(){QCMeditors.qFocusOn!==nbQ-1&&this.myMove("last")},supprQ:function(){var elem=document.getElementById("editor"+QCMeditors.qFocusOn),i;for(i=QCMeditors.qFocusOn;i<nbQ;i++)qreponses[i]=qreponses[i+1];void 0!==qreponses[nbQ]&&delete qreponses[nbQ],elem.parentNode.removeChild(elem),this.setAnimationWidth(),this.renameEditors(),this.updateNav(),null===comm.sessionId&&!1===comm.peerId||(changeNombreQuestions=!0)},insertQ:function(){this.renameEditors(QCMeditors.qFocusOn);for(var div=utils.htmlToElement('<div id="editor'+QCMeditors.qFocusOn+'" contenteditable="true" class="question"><h3>Question '+(QCMeditors.qFocusOn+1)+":</h3> <ol><li>&nbsp;</li></ol></div>"),refNode=document.getElementById("editor"+(QCMeditors.qFocusOn+1)),i=nbQ-1;i>=QCMeditors.qFocusOn;i--)qreponses[i+1]=qreponses[i];void 0!==qreponses[QCMeditors.qFocusOn]&&delete qreponses[QCMeditors.qFocusOn],refNode.parentNode.insertBefore(div,refNode),this.setAnimationWidth(),this.reloadCKEDITOR(),this.updateNav(),null===comm.sessionId&&!1===comm.peerId||(changeNombreQuestions=!0)},supprAllQ:function(){var elem;document.getElementById("animate").innerHTML='<div id="editor0" contenteditable="true" class="question"><h3>Question 1 :</h3> <ol><li>&nbsp;</li></ol></div>',qdatas={},qreponses={},totaux={A:0,B:0,C:0,D:0},nbQ=1,QCMeditors.qFocusOn=0,this.setAnimationWidth(),this.updateNav(),this.reloadCKEDITOR(),answers.resetAll(),null===comm.sessionId&&!1===comm.peerId||(changeNombreQuestions=!0)},moveQLeft:function(){if(0===QCMeditors.qFocusOn)return!1;var rtemp=qreponses[QCMeditors.qFocusOn-1];qreponses[QCMeditors.qFocusOn-1]=qreponses[QCMeditors.qFocusOn],qreponses[QCMeditors.qFocusOn]=rtemp;var elem=document.getElementById("editor"+QCMeditors.qFocusOn);elem.parentNode.removeChild(elem);var refNode=document.getElementById("editor"+(QCMeditors.qFocusOn-1));refNode.parentNode.insertBefore(elem,refNode),this.setAnimationWidth(),this.renameEditors(),this.updateNav()},moveQRight:function(){var rtemp,refNode,elem=document.getElementById("editor"+QCMeditors.qFocusOn);if(QCMeditors.qFocusOn>nbQ-1)return!1;QCMeditors.qFocusOn<nbQ-2?(rtemp=qreponses[QCMeditors.qFocusOn+1],qreponses[QCMeditors.qFocusOn+1]=qreponses[QCMeditors.qFocusOn],qreponses[QCMeditors.qFocusOn]=rtemp,elem.parentNode.removeChild(elem),(refNode=document.getElementById("editor"+(QCMeditors.qFocusOn+2))).parentNode.insertBefore(elem,refNode)):(rtemp=qreponses[QCMeditors.qFocusOn+1],qreponses[QCMeditors.qFocusOn+1]=qreponses[QCMeditors.qFocusOn],qreponses[QCMeditors.qFocusOn]=rtemp,refNode.parentNode.appendChild(elem)),this.setAnimationWidth(),this.renameEditors(),this.updateNav()},updateNav:function(){this.updatenbQ(),reponseSimple=!0,nbQ>1&&(QCMeditors.qFocusOn>0?(document.getElementById("buttonLeft").className="",document.getElementById("buttonFirst").className=""):(document.getElementById("buttonLeft").className="inactiv",document.getElementById("buttonFirst").className="inactiv"),QCMeditors.qFocusOn<nbQ-1?(document.getElementById("buttonRight").className="",document.getElementById("buttonLast").className=""):(document.getElementById("buttonRight").className="inactiv",document.getElementById("buttonLast").className="inactiv")),QCMeditors.updateCheckAnwers("editor"+QCMeditors.qFocusOn);var reponseset=qreponses[QCMeditors.qFocusOn],sablier=document.getElementById("sablier");if(QCMeditors.times[this.qFocusOn]?(document.getElementById("temps").value=QCMeditors.times[this.qFocusOn],sablier.className=""):(document.getElementById("temps").value="00:00",sablier.className="cache"),void 0!==reponseset){if(answers.showResponses(reponseset),"string"==typeof reponseset){QCMeditors.changeTypeChoice("radio");try{document.getElementById("R"+reponseset).checked=!0}catch(error){}}else if(Array.isArray(reponseset)){reponseSimple=!1,QCMeditors.changeTypeChoice("checkbox");for(var elems=document.querySelectorAll("input[name='reponse']"),i=0;i<elems.length;i++)elems[i].checked=!1;if(reponseset.length>0)for(var i=0;i<reponseset.length;i++)document.getElementById("R"+reponseset[i]).checked=!0;else elems[i-1].checked=!0}"cache"!=document.getElementById("editionQuestions").className?QCMeditors.addStyle(QCMeditors.qFocusOn):utils.isEmpty(datas[QCMeditors.qFocusOn])&&QCMeditors.removeStyle(QCMeditors.qFocusOn),document.getElementById("revealanswer").className="",document.getElementById("goodAnswer").className="cache"}else QCMeditors.changeTypeChoice("radio"),document.getElementById("revealanswer").className="cache",document.getElementById("goodAnswer").className="";return document.getElementById("numquestion").innerHTML=QCMeditors.qFocusOn+1+"/"+nbQ,reponseset},myMove:function(direction){if(!0===QCMeditors.animation)return!1;if(0===QCMeditors.qFocusOn&&"r"===direction)return!1;camera.scanner(!1);var elem=document.getElementById("animate");if(QCMeditors.qFocusOn===nbQ-1&&"l"===direction)return!1;QCMeditors.animation=!0;var mLeft=Number(elem.style.marginLeft.slice(0,-1)),espaceToGo=100;"last"===direction?espaceToGo=100*(nbQ-QCMeditors.qFocusOn-1):"first"===direction&&(espaceToGo=100*QCMeditors.qFocusOn);var pas=espaceToGo/20,pos=0;function frame(){if(pos>=espaceToGo){clearInterval(QCMeditors.interval),QCMeditors.interval=null,QCMeditors.animation=!1,!1!==camera.video&&camera.tick(),void 0!==qdatas[QCMeditors.qFocusOn]&&(datas=qdatas[QCMeditors.qFocusOn]);var reponseset=QCMeditors.updateNav();answers.updateVotes(),answers.compteValeurs(reponseset),!1!==camera.video&&"l"===direction&&(camera.manualStopScan=!1,camera.scanner(!0)),null===comm.sessionId&&!1===comm.peerId||(changeQuestionFocus=!0)}else pos+=pas,elem.style.marginLeft="l"===direction||"last"===direction?mLeft-pos+"%":mLeft+pos+"%"}utils.setChrono(),qdatas[QCMeditors.qFocusOn]=datas,datas={},"l"===direction?QCMeditors.qFocusOn++:"r"===direction?QCMeditors.qFocusOn--:"last"===direction?QCMeditors.qFocusOn=nbQ-1:"first"===direction&&(QCMeditors.qFocusOn=0),answers.initAll(),answers.updateVotes(),QCMeditors.interval=setInterval(frame,1)},setQuestionsWidth:function(){var divs=document.getElementsByClassName("question");if(divs.length>0){var percentLength=1/divs.length*100,i=0;for(i=0;i<divs.length;i++)divs[i].style.width=percentLength+"%"}return!0},download:function(TF){utils.setChrono();var content={},nq=0,nomfichier,styleQuestions=document.getElementById("questions").style;for(var name in""===styleQuestions.width&&""===styleQuestions.height||(content.size={width:styleQuestions.width,height:styleQuestions.height}),CKEDITOR.instances)content[nq]={question:CKEDITOR.instances[name].getData()},void 0!==qreponses[nq]&&(content[nq].reponse=qreponses[nq]),QCMeditors.times[nq]&&(content[nq].time=QCMeditors.times[nq]),nq++;content=JSON.stringify(content),utils.storageAvailable("localStorage")&&void 0===TF&&content.length<25e5&&(nomfichier=QCMeditors.saveToLocalStorage(content));var contentType,filename=null!=nomfichier&&""!==nomfichier?nomfichier+".txt":"questions.txt",blob=new Blob([content],{type:"text/plain"});if(void 0!==TF)return blob;download(blob,filename,"text/plain")},saveToLocalStorage:function(content,nomfichier){var lastcontent={},filename;if(void 0!==nomfichier&&(filename=nomfichier),void 0!==localStorage.lastQ){var tailleOK=(localStorage.lastQ+content).length<25e5;if(lastcontent=JSON.parse(localStorage.lastQ),!tailleOK){var tempmin=1/0;for(var i in lastcontent)Number(i)<tempmin&&(tempmin=Number(i)),lastcontent[i].name===nomfichier&&delete lastcontent[i];delete lastcontent[tempmin]}}return void 0===filename&&(filename=window.prompt("Quel nom pour votre questionnaire ?\n(laisser vide ou Annuler pour ne pas garder en mémoire)")),null!==filename&&""!==filename&&(lastcontent[Date.now()]={name:filename+(void 0!==nomfichier?"":".txt"),content:content},localStorage.lastQ=JSON.stringify(lastcontent)),filename},openFile:function(event){var input=event.target,reader=new FileReader;reader.onload=function(){utils.montrerPasteUrl(!1),utils.storageAvailable("localStorage")&&reader.result.length<25e5&&QCMeditors.saveToLocalStorage(reader.result,input.files[0].name),QCMeditors.replaceQuestions(reader.result)},reader.readAsText(input.files[0])},loadLastQCM:function(){if(void 0!==localStorage.lastQ&&"{}"!==localStorage.lastQ){var questionnaires=JSON.parse(localStorage.lastQ),cpt=0,id;for(var i in questionnaires)cpt++,id=i;if(id<1e4){var temp=localStorage.lastQ;delete localStorage.lastQ,QCMeditors.saveToLocalStorage(temp,"Ancien historique"),QCMeditors.replaceQuestions(temp)}else if(cpt>=1){utils.class("lastcontents","");var el=document.getElementById("lc-content"),chaine="<ul>";for(var i in questionnaires)chaine+='<li><span onclick="QCMeditors.insertHistoricalQCM('+i+');">'+questionnaires[i].name+'</span> - <input type="image" src="css/img/process-stop.png" onclick="QCMeditors.deleteThisHistorique('+i+')"></li>';chaine+="</ul>",el.innerHTML=chaine}}else utils.class("lastcontents","cache"),utils.class("btnrq","cache")},insertHistoricalQCM:function(id){var quests=JSON.parse(localStorage.lastQ);QCMeditors.replaceQuestions(quests[id].content)},deleteThisHistorique:function(id){var quests=JSON.parse(localStorage.lastQ);delete quests[id],localStorage.lastQ=JSON.stringify(quests),QCMeditors.loadLastQCM()},addStyle:function(questionNumber){let liInOl=document.querySelectorAll("#editor"+questionNumber+".question > ol li");liInOl.length>0&&liInOl.forEach(el=>{el.classList.remove("rondvert")});let liInTable=document.querySelectorAll("#editor"+questionNumber+" table li");if(liInTable.length>0&&liInTable.forEach(el=>{el.classList.remove("rondvert")}),void 0===qreponses[questionNumber])return!1;var s=[],se=null;qreponses[questionNumber].indexOf("A")>-1&&s.push(1),qreponses[questionNumber].indexOf("B")>-1&&s.push(2),qreponses[questionNumber].indexOf("C")>-1&&s.push(3),qreponses[questionNumber].indexOf("D")>-1&&s.push(4);for(var i=0;i<s.length;i++)liInOl.length>0&&liInOl[s[i]-1].classList.add("rondvert"),liInTable.length>0&&liInTable[s[i]-1].classList.add("rondvert")},removeStyle:function(questionNumber){return!0},loadFile:function(url,TF){let reader=new XMLHttpRequest;if(TF)return reader.open("GET",url,!1),reader.onreadystatechange=function(){if(4===reader.readyState&&(200===reader.status||0===reader.status))try{QCMeditors.replaceQuestions(reader.responseText),void 0!==myWindow&&myWindow.close()}catch(err){console.error(err)}},void reader.send(null);reader.onload=function(){try{QCMeditors.replaceQuestions(reader.responseText)}catch(err){console.error(err)}},reader.open("get","phploader.php?url="+encodeURIComponent(url),!0),reader.send(),void 0!==myWindow&&myWindow.close()},replaceQuestions:function(json){QCMeditors.unloadCKEDITOR(),utils.class("lastcontents","cache");var questionsreponses={},i;if(json.indexOf("|#|")>-1){var qr=json.split("|json|"),qs=qr[0].split("|#|");for(qr=void 0!==qr[1]?JSON.parse(qr[1]):{},i=0;i<qs.length;i++)questionsreponses[i]={question:qs[i],reponse:qr[i]}}else questionsreponses=JSON.parse(json);var elem=document.getElementById("animate");for(i in qreponses={},elem.innerHTML="",nbQ=0,QCMeditors.times=[],questionsreponses)"size"!==i&&(void 0!==questionsreponses[i].time&&(QCMeditors.times[i]=questionsreponses[i].time),nbQ++,""!==questionsreponses[i].question&&(elem.innerHTML+='<div id="editor'+i+'" contenteditable="false" class="question">'+questionsreponses[i].question+"</div>"),void 0!==questionsreponses[i].reponse&&(qreponses[Number(i)]=questionsreponses[i].reponse));if(utils.closeEditionOptions(),utils.renderKatex("animate"),utils.renderCode(),QCMeditors.qFocusOn=0,this.setAnimationWidth(),this.updateNav(),answers.resetAll(),void 0!==questionsreponses.size){var styleQuestions=document.getElementById("questions").style;styleQuestions.width=questionsreponses.size.width,styleQuestions.height=questionsreponses.size.height}this.toggleCacheQuestions("show"),QCMeditors.fileJustLoaded=!0},toggleCacheQuestions:function(state){var cache=document.getElementById("cacheQuestions");let animate=document.getElementById("animate");var widthQ=document.getElementById("questions").offsetWidth;cache.style.width=widthQ+"px","cache"===cache.className&&void 0===state||"show"===state?(cache.className="montre",animate.classList.add("blur")):(cache.className="cache",animate.classList.remove("blur"))},changeTypeChoice:function(what){let btn=document.getElementById("btncc"),elems=document.querySelectorAll("input[name='reponse']");if(void 0===what&&"radio"===elems[0].type||"checkbox"===what){reponseSimple=!1;for(let i=0;i<elems.length;i++)elems[i].type="checkbox";if(void 0===what||void 0===qreponses[QCMeditors.qFocusOn]){qreponses[QCMeditors.qFocusOn]=[];for(let i=0;i<elems.length;i++)elems[i].checked&&i<4&&qreponses[QCMeditors.qFocusOn].push(elems[i].value)}btn.src="css/img/32px/multiplechoice.png",document.getElementById("editor"+QCMeditors.qFocusOn).classList.add("multiple")}else{reponseSimple=!0,document.getElementById("revealanswer").className="cache",document.getElementById("goodAnswer").className="",btn.src="css/img/32px/onechoice.png";for(var i=0;i<elems.length;i++)elems[i].type="radio",elems[i].checked=!1;elems[i-1].checked=!0,void 0===what&&delete qreponses[QCMeditors.qFocusOn],document.getElementById("editor"+QCMeditors.qFocusOn).classList.remove("multiple")}},setItemsiFrameDialog:function(dialog,evt){if(dialog&&evt){var theiframe=null,div=document.createElement("DIV");div.innerHTML=evt.clipboardData.getData("text/plain"),(theiframe=div.querySelector("iframe"))&&(void 0!==theiframe.src&&setTimeout((function(){dialog.setValueOf("info","src",theiframe.src)}),50),void 0!==theiframe.width&&dialog.setValueOf("info","width",theiframe.width),void 0!==theiframe.height&&dialog.setValueOf("info","height",theiframe.height),void 0!==theiframe.name&&dialog.setValueOf("info","name",theiframe.name))}},printQCM:function(){var content={},nq=0;for(var name in QCMeditors.loadCKEDITOR(),CKEDITOR.instances)content[nq]={question:CKEDITOR.instances[name].getData()},void 0!==qreponses[nq]&&(content[nq].reponse=qreponses[nq]),QCMeditors.times[nq]&&(content[nq].time=QCMeditors.times[nq]),nq++;var fenetre=window.open("print.html","QCMCam - impression");fenetre.onload=function(){fenetre.contenu=content,fenetre.AfficheReponses()}}},utils={intervaldecompte:null,startScanAfterAnime:!1,animationMenustart:!1,optionMenu:null,montrerPasteUrl:function(TF){var elt=document.getElementById("pasteUrl"),elt2=document.getElementById("inputurl");TF?(elt.className="",elt2.focus(),elt2.value="",elt2.addEventListener("paste",utils.urlVerify)):(elt.className="cache",elt2.removeEventListener("paste",utils.urlVerify))},gotoGitHub(){window.location.href="https://github.com/seb-cogez/QCMCam"},setterFullHD:function(bool){document.getElementById("setterFullHD").className=bool?"":"cache"},affichageStyle:function(taille){document.getElementById("questionsContener").style.fontSize=taille+"em"},urlVerify:function(evt){utils.montrerPasteUrl(!1);var url=evt.clipboardData.getData("text/plain"),regex,regexDrive=/drive\.google\.com/,regexDropbox=/dropbox.com/;/^http/i.test(url)?(regexDrive.test(url)&&(url=url.replace("/open?","/uc?export=download&")),regexDropbox.test(url)&&(url=url.replace("dl=0","dl=1")),QCMeditors.loadFile(url)):alert(url+" n'est pas une url valide")},toggleOptions:function(id){var elem;"cache"===document.getElementById(id).className?"editionParticipants"===id?this.openParticipantsOptions():this.openEditionOptions():"editionParticipants"===id?this.closeParticipantsOptions():this.closeEditionOptions()},openEditionOptions:function(){QCMeditors.toggleCacheQuestions(!1),document.getElementById("commandeslive").className="cache",QCMeditors.loadCKEDITOR(),QCMeditors.addStyle(QCMeditors.qFocusOn),document.getElementById("btng").style.opacity=.5,document.getElementById("editionQuestions").className=""},closeEditionOptions:function(){QCMeditors.unloadCKEDITOR(!0),document.getElementById("commandeslive").className="",QCMeditors.removeStyle(QCMeditors.qFocusOn),document.getElementById("btng").style.opacity=1,document.getElementById("editionQuestions").className="cache"},openParticipantsOptions:function(){document.getElementById("importliste").addEventListener("paste",users.pasteUsersImport),document.getElementById("navigation").className="cache",document.getElementById("btnop").style.opacity=.5,document.getElementById("editionParticipants").className=""},closeParticipantsOptions:function(){document.getElementById("importliste").removeEventListener("paste",users.pasteUsersImport),document.getElementById("navigation").className="",users.edit(!0),users.setDeleteMode(!0),document.getElementById("btnop").style.opacity=1,document.getElementById("editionParticipants").className="cache"},htmlToElement:function(html){var template=document.createElement("template");return template.innerHTML=html,template.content.firstChild},isEmpty:function(obj){var x;for(x in obj)return!1;return!0},shuffle:function(arr){return!!Array.isArray(arr)&&(arr.sort(()=>Math.random()-.5),arr)},removeElement:function(array,elem){var index=array.indexOf(elem);index>-1&&array.splice(index,1)},compareArrays:function(a1,a2){if(a1.length!==a2.length)return!1;for(var i=0;i<a1.length;i++)if(a2.indexOf(a1[i])<0)return!1;return!0},changeCode:function(num){return[3,4,5].indexOf(num)>=0&&(typeCode=num,corres=correspondances["p"+num],alert("Mode "+num+" bits activé."),!0)},storageAvailable:function(type){try{var storage=window[type],x="__storage_test__";return storage.setItem(x,x),storage.removeItem(x),!0}catch(e){return e instanceof DOMException&&(22===e.code||1014===e.code||"QuotaExceededError"===e.name||"NS_ERROR_DOM_QUOTA_REACHED"===e.name)}},afficheAccueil:function(truefalse){void 0===truefalse&&(truefalse=!0),"cache"===utils.class("messageacceuil")&&truefalse?(utils.class("messageacceuil","flex"),utils.class("listeeleves","cache"),utils.class("boutonsuserslive","cache")):(utils.class("messageacceuil","cache"),utils.class("listeeleves",""),utils.class("boutonsuserslive",""))},pleinEcran:function(){screenfull.enabled&&screenfull.toggle()},animeMenuFin:function(){var elt1;document.getElementById("commandesQuestions").removeEventListener("animationend",utils.animeMenuFin),!scan&&utils.startScanAfterAnime?(scan=!0,validrep={},camera.canvas.style.opacity="1",camera.interval=setInterval(answers.tests,1e3)):utils.startScanAfterAnime||(scan=!1),utils.animationMenustart=!1,utils.optionMenu=null},animeMenu:function(option){var elt1=document.getElementById("commandesQuestions"),elt2=document.getElementById("panneauHautDroite"),elt3=document.getElementById("footersmartphone");utils.animationMenustart?utils.optionMenu!==option&&utils.animeMenuFin():utils.optionMenu=null;for(var tous=[elt1,elt2],i=0;i<tous.length;i++)"down"===option?(tous[i].className="animated slideInDown",elt3.className="animated slideInUp",utils.startScanAfterAnime=!1):(tous[i].className="animated slideOutUp",elt3.className="animated slideOutDown",utils.startScanAfterAnime=!0);utils.animationMenustart=!0,utils.optionMenu=option,elt1.addEventListener("animationend",utils.animeMenuFin)},Infos:function(option){document.getElementById("infos").className="open"===option?"":"cache"},select:function(elem){var range=document.createRange();range.selectNodeContents(elem);var selection=window.getSelection();selection.removeAllRanges(),selection.addRange(range)},getUrlVars:function(){for(var vars=[],hash,hashes=window.location.href.slice(window.location.href.indexOf("?")+1).split("&"),len=hashes.length,i=0;i<len;i++)hash=hashes[i].split("="),vars.push(hash[0]),vars[hash[0]]=hash[1];return vars},lancerReveal:function(){utils.intervaldecompte=setInterval(utils.reveal,10)},reveal:function(){var decompte=Number(document.getElementById("intro").style.opacity);decompte<=.001?(document.getElementById("intro").style.display="none",clearInterval(utils.intervaldecompte)):document.getElementById("intro").style.opacity=decompte-.01},sortTable:function(n){var table,rows,switching,i,x,y,shouldSwitch,dir,switchcount=0;for(table=document.getElementById("tableau"),switching=!0,dir="asc";switching;){for(switching=!1,rows=table.getElementsByTagName("TR"),i=2;i<rows.length-1;i++)if(shouldSwitch=!1,x=rows[i].getElementsByTagName("TD")[n],y=rows[i+1].getElementsByTagName("TD")[n],"asc"===dir){if(this.isNumeric(x.innerHTML)&&this.isNumeric(y.innerHTML)){if(Number(x.innerHTML)>Number(y.innerHTML)){shouldSwitch=!0;break}}else if(x.innerHTML.toLowerCase()>y.innerHTML.toLowerCase()){shouldSwitch=!0;break}}else if("desc"===dir)if(this.isNumeric(x.innerHTML)&&this.isNumeric(y.innerHTML)){if(Number(x.innerHTML)<Number(y.innerHTML)){shouldSwitch=!0;break}}else if(x.innerHTML.toLowerCase()<y.innerHTML.toLowerCase()){shouldSwitch=!0;break}shouldSwitch?(rows[i].parentNode.insertBefore(rows[i+1],rows[i]),switching=!0,switchcount++):0===switchcount&&"asc"===dir&&(dir="desc",switching=!0)}},openLibrary:function(){void 0===myWindow?myWindow=window.open("repository/index.html","QCMCamLibrary","menubar=no,status=no,toolbar=no,scrollbars=yes"):myWindow.closed?(myWindow=window.open("repository/index.html","QCMCamLibrary","menubar=no,status=no,toolbar=no,scrollbars=yes")).focus():myWindow.focus()},closeLibrary:function(){void 0!==myWindow&&myWindow.close()},isNumeric:function(value){return/^-{0,1}\d+$/.test(value)},class:function(id,className){if(void 0===className)return document.getElementById(id).className;document.getElementById(id).className=className},addScript:function(src,callback){var s,r;r=!1,(s=document.createElement("script")).type="text/javascript",s.src=src,s.onload=s.onreadystatechange=function(){r||this.readyState&&"complete"!==this.readyState||(r=!0,callback())},document.head.appendChild(s)},renderKatex:function(eltId){for(var elTex=document.querySelectorAll("#"+eltId+" .math-tex"),Tex,i=0;i<elTex.length;i++){Tex=(Tex=null!==elTex[i].querySelector("span.katex")?utils.decodeHtmlEntity(elTex[i].querySelector("annotation").innerHTML.trim()):utils.decodeHtmlEntity(elTex[i].innerHTML.trim())).replace(/\\[\(\)]/g,"");try{katex.render(Tex,elTex[i],{throwOnError:!1,errorColor:"#FFF"})}catch(err){elTex[i].innerHTML=err+" erreur de rendu avec "+Tex}}},revertKatex:function(eltId){for(var elKtex=document.querySelectorAll("#"+eltId+" .math-tex"),Tex=null,i=0;i<elKtex.length;i++)Tex=utils.decodeHtmlEntity(elKtex[i].querySelector("annotation").innerHTML),elKtex[i].innerHTML=Tex},renderCode:function(){document.querySelectorAll("pre code").forEach((function(block){block.dataset.code=block.innerHTML,hljs.highlightBlock(block)}))},revertHighlight:function(eltId){var eltcode=document.querySelectorAll("#"+eltId+" pre code").forEach((function(block){block.innerHTML=block.dataset.code}))},decodeHtmlEntity:function(str){return(str=(str=str.replace(/\&amp;/g,"&")).replace(/\&lt;/g,"<")).replace(/\&gt;/g,">")},encodeHtmlEntity:function(str){return buf.join("")},convertTimeToms:function(nb){if("number"==typeof nb&&nb>1e3){nb*=.001;var minutes=Math.floor(nb/60),secondes=nb%60;return nb=(minutes>=10?minutes:"0"+minutes)+":"+(secondes>=10?secondes:"0"+secondes)}return"string"==typeof nb&&nb.indexOf(":")>-1&&(nb=Math.round(6e4*Number(nb.substring(0,nb.indexOf(":")))+1e3*Number(nb.substring(nb.indexOf(":")+1))))},setChrono:function(){var temps=document.getElementById("temps").value;""!==temps&&"00:00"!==temps&&"00:00:00"!==temps?QCMeditors.times[QCMeditors.qFocusOn]=temps:delete QCMeditors.times[QCMeditors.qFocusOn]},startChrono:function(){if(!QCMeditors.times[QCMeditors.qFocusOn])return!1;document.getElementById("sablier").className="",utils.now=Date.now(),utils.endChrono=utils.now+utils.convertTimeToms(QCMeditors.times[QCMeditors.qFocusOn]),utils.duree=utils.endChrono-utils.now;let barre=document.getElementById("chronorect");barre.style.width="100%",barre.style.backgroundColor=null,utils.intervalChrono=setInterval(utils.checkTime,100)},checkTime(){var now=Date.now(),barre=document.getElementById("chronorect"),decompte=document.getElementById("decompte");now>utils.endChrono?(camera.scanner(!1),utils.intervalChrono=null,barre.style.backgroundColor=null,barre.style.width=0,decompte.innerHTML="00:00"):(utils.endChrono-now>9825&&utils.endChrono-now<10075&&(barre.style.backgroundColor="red"),decompte.innerHTML=utils.convertTimeToms(1e3*Math.ceil(.001*(utils.endChrono-now))),barre.style.width=.01*Math.ceil((utils.endChrono-now)/utils.duree*1e4)+"%")},showSablier:function(value){var elt=document.getElementById("sablier");""!==value&&utils.convertTimeToms(value)?(elt.className="",QCMeditors.times[QCMeditors.qFocusOn]=void 0):(elt.className="cache",QCMeditors.times[QCMeditors.qFocusOn]=value)}},QCMCam={lang:{text:function(){var chaine=arguments[0];if(void 0!==arguments[1])for(var i=1;i<arguments.length;i++)chaine=chaine.replace("{}",arguments[i]);return chaine},translate:function(){var els,json,attr,chaine;QCMCam.lang.loadLang(!0)&&(CKEDITOR.config.language=lang,document.querySelectorAll("*[data-translate]").forEach((function(item){for(var i in json=JSON.parse(item.dataset.translate))attr=json[i].split("."),chaine=QCMCam.lang[lang][attr[0]][attr[1]],"html"===i?item.innerHTML=chaine:item[i]=chaine})),utils.isEmpty(CKEDITOR.instances)||QCMeditors.reloadCKEDITOR())},loadLang:function(force){if("fr"===lang&&void 0===force)return!1;if(["en","es","fr","de","it"].indexOf(lang)<0)return lang="fr",alert("Your language is not supported, default is french.\n\nYou can switch to Spanish, English, Italian or German\nin the bottom.\n\nOr you can help translating. See Info"),!1;if(void 0===QCMCam.lang[lang]){var script="js/lang/"+lang+".js",callback=function(){return!1};return force&&(callback=QCMCam.lang.translate),utils.addScript(script,callback),!1}return!0},changeLanguage:function(newlang){lang=newlang,QCMCam.lang.translate(!0)}}};QCMCam.lang.loadLang();var users={supprMode:!1,absents:{},college:null,classe:null,eleves:{},interroges1:[],interroges2:[],listeTirages:[],collegeinit:{GP1:{1:"Participant 1",2:"Participant 2",3:"Participant 3",4:"Participant 4",5:"Participant 5",6:"Participant 6",7:"Participant 7",8:"Participant 8",9:"Participant 9",10:"Participant 10",11:"Participant 11",12:"Participant 12",13:"Participant 13",14:"Participant 14",15:"Participant 15",16:"Participant 16",17:"Participant 17",18:"Participant 18",19:"Participant 19",20:"Participant 20",21:"Participant 21",22:"Participant 22",23:"Participant 23",24:"Participant 24",25:"Participant 25",26:"Participant 26",27:"Participant 27",28:"Participant 28",29:"Participant 29",30:"Participant 30",effectif:30},GP2:{1:"Di Alain",2:"Onyme Anne",3:"Chaud Artie",4:"Malaki Ben",5:"Onxa Cécile",6:"Obscur Clair",7:"Zore Dino",8:"Cicode David",9:"Coptaire Eli",10:"Rice Edith",11:"Oposte Fidel",12:"Gafatoy Fabien",13:"Mansoif Gérard",14:"Héparbal Gilles",15:"Bol Guy",16:"Perret Inès",17:"Peuplu Jean",18:"Instant Justin",19:"Dioci Kelly",20:"Chevée Lyna",21:"Dévous Laurent",22:"Nord Paul",23:"Tounet Patrice",24:"Sagratte Sandra",25:"Stickey Sophie",26:"Jasmin Théo",27:"Hate Tom",28:"Timaitre Vincent",29:"Elnypoivre Yannis",30:"Débobe Yvan",effectif:30}},pasteUsersImport:function(evt){users.import(evt.clipboardData.getData("text/plain"))},setDeleteMode:function(force){this.supprMode||force?this.removeSupprButton():this.addSuprrButton()},addSuprrButton:function(){this.supprMode=!0;var elements=document.getElementsByClassName("eleve"),i;if(void 0===elements.length)return!1;for(i=0;i<elements.length;i++)elements[i].childNodes[1].className="supprButton"},removeSupprButton:function(){this.supprMode=!1;var elements=document.getElementsByClassName("eleve"),i;if(elements.length)for(i=0;i<elements.length;i++)elements[i].childNodes[1].className="cache"},afficheReponses:function(doIt){void 0===doIt&&(doIt=!0);var btn=document.getElementById("btnb");"cache"===utils.class("colonnes")&&doIt?(utils.class("colonnes","inline-block"),utils.class("conteneureleves","cache"),btn.src="css/img/32px/students.png",btn.title="Voir les élèves (ALT+V)",scan&&camera.scanner(!1)):(utils.class("colonnes","cache"),utils.class("conteneureleves",""),btn.src="css/img/32px/stats.png",btn.title="Voir les réponses (ALT+V)")},delete:function(id,saveok){void 0===saveok&&(saveok=!0),void 0!==users.eleves[id]&&(delete users.eleves[id],users.eleves.effectif--,void 0!==datas[id]&&delete datas[id],users.show(),users.classe&&saveok&&utils.class("btnsaveclasses","")),answers.updateVotes()},appel:function(){if(confirm(QCMCam.lang[lang].messages.deleteabsentees)){if(camera.scanner(!1),utils.isEmpty(users.eleves))return!1;var i;for(i in users.absents={effectif:0},users.eleves)"effectif"!==i&&void 0===datas[i]&&(users.absents[i]=users.eleves[i],users.absents.effectif++,users.delete(i,!1));answers.updateVotes()}},show:function(){document.getElementById("messageacceuil").className="cache",document.getElementById("boutonsuserslive").className="";var txt="",classSuppr="cache";for(var i in users.supprMode&&(classSuppr="supprButton"),users.eleves)"effectif"!==i&&(txt+=!0===namesvisible?'<div class="eleve" id="el'+i+'" title="'+users.eleves[i]+'"><span class="numero">'+i+"</span><span id='delete"+i+"' class='"+classSuppr+"' onclick='users.delete("+i+");'>×</span><span class='cache' id='addrep"+i+"'>+</span><span class='cache' id='supprrep"+i+"'>‒</span><span class='participant'>"+users.eleves[i]+"</span></div>":'<div class="eleve" id="el'+i+'" title="'+users.eleves[i]+'"><span class="numero">'+i+"</span><span id='delete"+i+"' class='"+classSuppr+"' onclick='users.delete("+i+");'>×</span><span class='cache' id='addrep"+i+"'>+</span><span class='cache' id='supprrep"+i+"'>‒</span><span class='participant' style='display:none;'>"+users.eleves[i]+"</span></div>");document.getElementById("listeeleves").innerHTML=txt},firstImport:function(){return utils.storageAvailable("localStorage")&&void 0!==localStorage.college?(users.college=JSON.parse(localStorage.college),users.peuplerSelectClasses("fromMemory"),void(document.getElementById("btnresetclasses").className="")):(users.college=Object.assign({},users.collegeinit),users.peuplerSelectClasses("basic"),!0)},resetCollege:function(){if(!confirm(QCMCam.lang[lang].usersPanel.restoreDefaults))return!1;users.college=Object.assign({},users.collegeinit),users.peuplerSelectClasses("basic"),document.getElementById("btnresetclasses").className="cache",utils.storageAvailable("localStorage")&&void 0!==localStorage.college&&delete localStorage.college},edit:function(forceclose){var elem=document.getElementById("btnednames"),participants=document.getElementsByClassName("eleve");if(0===participants.length)return alert(QCMCam.lang[lang].messages.nothingtoedit),!1;var i=0,c1,c2,ceditable="#ffe6b3",cuneditable="#FFF",cborder="1px dotted #333",cborderoff="",focus=function(){utils.select(this)},focusoff=null,editable=participants[0].childNodes[0].isContentEditable||forceclose;for(editable?(elem.style.opacity=1,document.getElementById("messageedition").className="cache"):(elem.style.opacity=.4,document.getElementById("messageedition").className=""),i=0;i<participants.length;i++)c1=participants[i].childNodes[0],c2=participants[i].childNodes[4],editable?(c1.contentEditable=!1,c1.style.backgroundColor="#FFF",c1.style.border="",c1.onfocus=null,c1.onchange=null,c2.contentEditable=!1,c2.style.backgroundColor="#FFF",c2.style.border="",c2.onfocus=null,c2.onchange=null):(c1.contentEditable=!0,c1.style.backgroundColor="#ffe6b3",c1.style.border=cborder,c1.onfocus=focus,c2.contentEditable=!0,c2.style.backgroundColor="#ffe6b3",c2.style.border=cborder,c2.onfocus=focus,users.classe&&(c1.onfocus=function(){this.data_origin=this.innerHTML},c2.onfocus=function(){this.data_origin=this.innerHTML},c1.onblur=function(){this.innerHTML!==this.data_origin&&(document.getElementById("btnsaveclasses").className="")},c2.onblur=function(){this.innerHTML!==this.data_origin&&(document.getElementById("btnsaveclasses").className="")}));editable&&users.updateAfterEdit()},updateAfterEdit:function(){var participants=document.getElementsByClassName("eleve");if(0===participants.length)return!1;var id,nom,ok=!0,i;for(users.eleves={effectif:0},i=0;i<participants.length;i++)id=Number(participants[i].childNodes[0].innerHTML),nom=participants[i].childNodes[4].innerHTML,void 0===users.eleves[id]?(users.eleves[id]=nom,users.eleves.effectif++):(ok=!1,alert(QCMCam.lang.text(QCMCam.lang[lang].messages.twicenumber,id)));ok&&answers.resetAll()},setGroup:function(classe){utils.afficheAccueil(!1),utils.class("btnsaveclasses","cache"),this.interroges1=[],this.interroges2=[],this.listeTirages=[],void 0!==classe?void 0!==users.college[classe]?("uploaded"!==classe&&(users.classe=classe),users.eleves=users.college[classe],answers.resetAll()):document.getElementById("listeeleves").innerHTML=QCMCam.lang.text(QCMCam.lang[lang].messages.nostudent,classe):document.getElementById("listeeleves").innerHTML=QCMCam.lang[lang].messages.noclass},emtpy:function(){confirm(QCMCam.lang[lang].messages.empty)&&(users.eleves={},answers.resetAll(),users.classe=null)},add:function(){var nb=Number(prompt(QCMCam.lang[lang].messages.adduser));""===nb&&(nb=1);var usersNb=Object.keys(users.eleves).length;if(nb>60||usersNb+nb>60)return alert("Votre nombre est trop grand. Vous ne devez pas dépasser 60 utilisateurs"),!1;var i=0,maxKey=0,keytemp=0;for(i=0;i<usersNb;i++)(keytemp=Number(Object.keys(users.eleves)[i]))>maxKey&&(maxKey=keytemp);for(i=0;i<nb;i++)users.eleves[maxKey+i+1]=QCMCam.lang[lang].messages.participant+" "+(maxKey+i+1);answers.resetAll(),users.classe&&(document.getElementById("btnsaveclasses").className="")},toggle:function(){var i=0,noms=document.getElementsByClassName("participant");for(i=0;i<noms.length;i++)noms[i].style.display=!0===namesvisible?"none":"inline-block";!0===namesvisible?(namesvisible=!1,document.getElementById("btnnames").src="css/img/32px/if_user_search_66914.png"):(namesvisible=!0,document.getElementById("btnnames").src="css/img/32px/if_user_delete_66908.png")},alea:function(type){if(void 0===users.eleves.effectif)return void alert(QCMCam.lang[lang].messages.groupmusthave);if((!1===type||!0===type)&&void 0===qreponses[QCMeditors.qFocusOn])return void alert(QCMCam.lang[lang].messages.goodanswermusthave);let i=0,table=[];for(i in datas)Number(i)>0&&(void 0===type?table.push(i):type&&(datas[i].vote===qreponses[QCMeditors.qFocusOn]||utils.compareArrays(datas[i].vote,qreponses[QCMeditors.qFocusOn]))?table.push(i):!type&&(reponseSimple&&datas[i].vote!==qreponses[QCMeditors.qFocusOn]||!reponseSimple&&!utils.compareArrays(datas[i].vote,qreponses[QCMeditors.qFocusOn]))&&table.push(i));if(0===table.length&&void 0===type)for(i in users.eleves)Number(i)>0&&table.push(i);else if(0===table.length)return void alert("Personne n'ayant répondu, action impossible");let alea=0,ok=!1,breakafter500=0;if(void 0===type){do{if(alea=Math.floor(Math.random()*table.length),breakafter500++,this.interroges1.indexOf(alea)<0?(ok=!0,this.interroges1.push(alea),this.interroges1.length===table.length&&(this.interroges1=[])):table.length>5&&this.interroges2.indexOf(alea)<0&&this.listeTirages.indexOf(alea)<this.listeTirages.length-5&&(ok=!0,this.interroges2.push(alea),this.interroges2.length===table.length&&(this.interroges2=[])),breakafter500>500){console.error("oups");break}}while(!ok);this.listeTirages.push(alea)}else alea=Math.floor(Math.random()*table.length);document.getElementById("el"+table[alea]).className="eleveevident",setTimeout((function(){document.getElementById("el"+table[alea]).className="eleve"}),5e3)},download:function(){var content="",i=0,participants=document.getElementsByClassName("eleve");if(0===participants.length)return alert("pas de participant à télécharger."),!1;for(i=0;i<participants.length;i++)content+=participants[i].childNodes[0].innerHTML+"\t"+participants[i].childNodes[4].innerHTML+"\r\n";var contentType,filename="participants.txt",blob=new Blob([content],{type:"text/plain"});download(blob,filename,"text/plain")},savelist:function(){users.classe&&(users.college[users.classe]=users.eleves,document.getElementById("btnsaveclasses").className="cache",utils.storageAvailable("localStorage")&&(localStorage.college=JSON.stringify(users.college)))},groupsDownload:function(){var content="",i,j;if(!users.college)return alert(QCMCam.lang[lang].messages.nogroup),!1;for(i in users.college)if("uploaded"!==i&&void 0!==users.college[i].effectif)for(j in users.college[i])"effectif"!==j&&(content+=j+"\t"+users.college[i][j]+"\t"+i+"\r\n");if(""===content)return alert("Pas de données à télécharger."),!1;var contentType,filename="participants.txt",blob=new Blob([content],{type:"text/plain"});download(blob,filename,"text/plain")},openFile:function(event){var input=event.target,reader=new FileReader;reader.onload=function(){users.import(reader.result)},reader.readAsText(input.files[0])},import:function(liste){users.classe=null;var withClasses=!1,nomsClasses=[],compteurIds=1,lines=liste.split(/[\r\n]+/g);users.college.uploaded={effectif:0};for(var i=0;i<lines.length;i++)if(""!==lines[i].trim()){var text=lines[i].split("\t");3===text.length?(withClasses=!0,nomsClasses.indexOf(text[2].trim())<0&&(nomsClasses.push(text[2].trim()),users.college[text[2].trim()]={},users.college[text[2].trim()].effectif=0),users.college[text[2].trim()][text[0].trim()]=text[1].trim(),users.college[text[2].trim()].effectif++):1===text.length?(users.college.uploaded[compteurIds++]=text[0].trim(),users.college.uploaded.effectif++):(users.college.uploaded[text[0].trim()]=text[1].trim(),users.college.uploaded.effectif++)}if(withClasses){for(var classe in users.college)nomsClasses.indexOf(classe)<0&&delete users.college[classe];users.peuplerSelectClasses("new"),document.getElementById("btnresetclasses").className="",utils.storageAvailable("localStorage")&&(localStorage.college=JSON.stringify(users.college))}else users.setGroup("uploaded")},peuplerSelectClasses:function(action){var message="";"new"===action&&(message=QCMCam.lang[lang].messages.importgroups+"<ul>");for(var x=document.getElementById("classes"),option,nomClasse,opts=x.getElementsByTagName("option");opts[1];)x.removeChild(opts[1]);for(nomClasse in users.college)("uploaded"!==nomClasse&&"GP1"!==nomClasse&&"GP2"!==nomClasse&&("new"===action||"fromMemory"===action)||"basic"===action&&"uploaded"!==nomClasse)&&((option=document.createElement("option")).text=nomClasse,option.value=nomClasse,x.add(option),message+="<li>"+nomClasse+"</li>");"new"===action&&(message+="</ul>",document.getElementById("listeeleves").innerHTML=message,utils.afficheAccueil(!1))},manageGroups:function(action){"open"===action?(utils.isEmpty(qdatas)?document.getElementById("group-with-score").className="cache":(answers.fillTable(),document.getElementById("group-with-score").className=""),document.getElementById("group-manager").className="",users.workgroup=new groupe(users.eleves),users.workgroup.display()):document.getElementById("group-manager").className="cache"}},answers={vuesMin:4,canvas:null,context:null,nbColors:11,scores:{},contextInit:function(){this.context=this.canvas.getContext("2d"),this.context.font="30px Arial",this.context.textAlign="center",this.context.fillText("A",25,460),this.context.fillText("B",75,460),this.context.fillText("C",125,460),this.context.fillText("D",175,460),this.context.font="16px Arial"},resetAll:function(){var i;this.initAll(),document.querySelectorAll(".question").forEach(el=>{el.classList.remove("corrige")}),qdatas={},this.scores={},(comm.sessionId>0||!1!==comm.peerId)&&(usersChangeDetected=!0)},initAll:function(move){if(void 0===move&&(move=!0),validrep={},datas={},totaux={A:0,B:0,C:0,D:0},document.getElementById("goodAnswer").options[0].selected="selected",answers.compteValeurs(),void 0===stylesheets[QCMeditors.qFocusOn]||move||QCMeditors.removeStyle(QCMeditors.qFocusOn),void 0!==users.eleves){var nbeleves=0;for(var i in users.eleves)!isNaN(parseFloat(i))&&isFinite(i)&&nbeleves++;users.eleves.effectif=nbeleves,users.show()}},updateVotes:function(){for(var i in datas)if(datas[i].nbvotes>0&&(document.querySelector("#el"+i+" > span:first-of-type").className="numerobleu",datas[i].nbvotes>1)){if(!datas[i].newvote)continue;!0===datas[i].newvote?document.getElementById("addrep"+i).className="addrep":"reset"===datas[i].newvote&&(document.getElementById("supprrep"+i).className="supprrep"),datas[i].newvote=!1}},tests:function(iswebcam){void 0===iswebcam&&(iswebcam=!0);var nbvals=0,now=Date.now();for(var i in datas)datas[i].timestamp+3e3<now&&(document.getElementById("addrep"+i).className="cache",document.getElementById("supprrep"+i).className="cache"),reponseSimple&&""!==datas[i].vote&&nbvals++;iswebcam&&nbvals===users.eleves.effectif&&!camera.manualStopScan&&reponseSimple&&(camera.scanner(!1),camera.manualStopScan=!0)},compteValeurs:function(value){for(var i in void 0===value&&(value="Z"),totaux={A:0,B:0,C:0,D:0},datas)if(reponseSimple)totaux[datas[i].vote]++;else for(var j=0;j<datas[i].vote.length;j++)totaux[datas[i].vote[j]]++;var h=430,colorsDefault={face:"#50D4FD",right:"#3da6c6",top:"#68dbff"},colorsGood={face:"#66ff33",right:"#4cbf26",top:"#8dff68"},colorsA=colorsDefault,colorsB=colorsDefault,colorsC=colorsDefault,colorsD=colorsDefault;answers.context.clearRect(0,0,200,433),answers.context.textAlign="center";var hA=10*totaux.A,hB=10*totaux.B,hC=10*totaux.C,hD=10*totaux.D;value.indexOf("A")>-1&&(colorsA=colorsGood),value.indexOf("B")>-1&&(colorsB=colorsGood),value.indexOf("C")>-1&&(colorsC=colorsGood),value.indexOf("D")>-1&&(colorsD=colorsGood),answers.traceColonne(10,h,hA,colorsA),answers.traceColonne(60,h,hB,colorsB),answers.traceColonne(110,h,hC,colorsC),answers.traceColonne(160,h,hD,colorsD),answers.context.fillStyle="#0033cc",answers.context.fillText(totaux.A,25,h-hA-10),answers.context.fillText(totaux.B,75,h-hB-10),answers.context.fillText(totaux.C,125,h-hC-10),answers.context.fillText(totaux.D,175,h-hD-10)},affecte:function(markerID,valeur){markerID=String(markerID);var timestamp=Date.now();if(!1===comm.peerId&&null===comm.sessionId){if(void 0===users.eleves[markerID])return!1;void 0===datas[markerID]?datas[markerID]=reponseSimple?{vote:"",nbvotes:0,voteTemp:valeur,vues:1,timestamp:timestamp}:{vote:[],nbvotes:0,timestamp:timestamp,newvote:!0,voteTemp:valeur,vues:1}:datas[markerID].voteTemp!==valeur?(datas[markerID].voteTemp=valeur,datas[markerID].vues=1):(datas[markerID].vues++,datas[markerID].vues>answers.vuesMin&&(reponseSimple&&datas[markerID].vote!==valeur?0===datas[markerID].nbvotes?(datas[markerID].vote=valeur,datas[markerID].nbvotes++):datas[markerID].timestamp+1e3<timestamp&&(datas[markerID].vote=valeur,datas[markerID].nbvotes++,datas[markerID].timestamp=timestamp,datas[markerID].newvote=!0):reponseSimple||(0===datas[markerID].nbvotes?(datas[markerID].vote.push(valeur),datas[markerID].newvote=!0,datas[markerID].nbvotes++,datas[markerID].timestamp=timestamp):datas[markerID].timestamp+3500<timestamp&&(datas[markerID].vues=1,datas[markerID].nbvotes++,datas[markerID].timestamp=timestamp,datas[markerID].vote.indexOf(valeur)<0?(datas[markerID].vote.push(valeur),datas[markerID].newvote=!0):(utils.removeElement(datas[markerID].vote,valeur),datas[markerID].newvote="reset")))))}else{if(void 0===users.eleves[markerID])return!1;datas[markerID].nbvotes++,datas[markerID].vote.indexOf(valeur)<0?reponseSimple?datas[markerID].vote=valeur:(datas[markerID].vote.push(valeur),datas[markerID].newvote=!0,datas[markerID].timestamp=timestamp):reponseSimple||(utils.removeElement(datas[markerID].vote,valeur),datas[markerID].newvote="reset",datas[markerID].timestamp=timestamp)}},showResponses:function(value){if(reponseSimple)for(var i in datas)""!==datas[i].vote&&(document.querySelector("#el"+i+" > span:first-of-type").innerHTML=datas[i].vote),datas[i].vote!==value?document.querySelector("#el"+i+" > span:first-of-type").className="numerorouge":document.querySelector("#el"+i+" > span:first-of-type").className="numerovert";else for(var i in datas)utils.compareArrays(value,datas[i].vote)?document.querySelector("#el"+i+" > span:first-of-type").className="numerovert":document.querySelector("#el"+i+" > span:first-of-type").className="numerorouge";return!0},setGoodAnswer:function(value){qreponses[QCMeditors.qFocusOn]=value,this.showResponses(qreponses[QCMeditors.qFocusOn]),this.compteValeurs(qreponses[QCMeditors.qFocusOn]),QCMeditors.addStyle(QCMeditors.qFocusOn),this.giveGoodAnswer(),!1!==arguments[1]&&(comm.sessionId>0||!1!==comm.peerId)&&(reponsesChangeDetected=!0)},setAnswer:function(value,type){if("radio"===type)"0"!==value?(qreponses[QCMeditors.qFocusOn]=value,document.getElementById("revealanswer").className="",document.getElementById("goodAnswer").className="cache"):(delete qreponses[QCMeditors.qFocusOn],document.getElementById("revealanswer").className="cache",document.getElementById("goodAnswer").className="");else if("0"!==value){var elem=document.querySelector("input[name='reponse'][value='0']");elem.checked=!1,(elem=document.querySelector("input[name='reponse'][value='"+value+"']")).checked?qreponses[QCMeditors.qFocusOn].push(value):utils.removeElement(qreponses[QCMeditors.qFocusOn],value),document.getElementById("revealanswer").className="",document.getElementById("goodAnswer").className="cache"}else{var elems=document.querySelectorAll("input[name='reponse']");qreponses[QCMeditors.qFocusOn]=[];for(var i=0;i<elems.length-1;i++)elems[i].checked=!1;document.getElementById("revealanswer").className="",document.getElementById("goodAnswer").className="cache"}QCMeditors.addStyle(QCMeditors.qFocusOn)},giveGoodAnswer:function(){if(void 0!==qreponses[QCMeditors.qFocusOn]){var value=qreponses[QCMeditors.qFocusOn];this.showResponses(value),this.compteValeurs(value),QCMeditors.addStyle(QCMeditors.qFocusOn),document.getElementById("editor"+QCMeditors.qFocusOn).classList.add("corrige")}},fillTable:function(){var tableau=document.getElementById("tableau");tableau.innerHTML="";var row=tableau.insertRow(0),color="red",cmptr=2,cells=[],i;for(void 0!==datas&&(qdatas[QCMeditors.qFocusOn]=datas),qexport='"id"\t"Nom"',cells.push("id"),cells.push("Nom"),i=0;i<nbQ;i++)qexport+='\t"Q'+(i+1)+'"',cells.push("Q"+(i+1));for(qexport+='\t"Score"',cells.push("score"),this.completeEntete(cells,row),row=tableau.insertRow(1),cells=["","<i>"+QCMCam.lang[lang].messages.goodanswer+"</i>"],qexport+='\r\n""\t"'+QCMCam.lang[lang].messages.goodanswer+'"',i=0;i<nbQ;i++)qexport+="\t",void 0!==qreponses[i]&&void 0!==qdatas[i]?(qexport+='"'+qreponses[i]+'"',cells.push("<b>"+qreponses[i]+"</b>")):cells.push("");for(i in this.completeLigne(cells,row),users.eleves)if("effectif"!==i){var score=0;cells=[i,users.eleves[i]],qexport+="\r\n"+i+'\t"'+users.eleves[i]+'"';for(var j=0;j<nbQ;j++)qexport+="\t",void 0!==qdatas[j]?void 0!==qdatas[j][Number(i)]?(Array.isArray(qdatas[j][i].vote)&&qdatas[j][i].vote.sort(),qexport+='"'+qdatas[j][i].vote+'"',void 0!==qreponses[j]&&(qreponses[j]===qdatas[j][i].vote||Array.isArray(qreponses[j])&&utils.compareArrays(qreponses[j],qdatas[j][i].vote)?(score++,color="green"):color="red"),cells.push("<span class='text-"+color+"'>"+qdatas[j][i].vote+"</span>")):cells.push(""):(qexport+="\t",cells.push(""));qexport+="\t"+score,cells.push(score),answers.scores[i]=score,row=tableau.insertRow(cmptr),this.completeLigne(cells,row),cmptr++}for(var entetes=document.querySelectorAll("#tableau th"),k=0;k<entetes.length;k++)entetes[k].colnum=k,entetes[k].addEventListener("click",(function(e){utils.sortTable(e.target.colnum)}))},afficherStats:function(){var divResults=document.getElementById("resultats");"cache responsive"===divResults.className?(this.fillTable(),divResults.className="responsive"):divResults.className="cache responsive"},completeLigne:function(cells,row){for(var cel,i=0;i<cells.length;i++)(cel=row.insertCell(i)).innerHTML=cells[i]},completeEntete:function(cells,row){for(var cel,i=0;i<cells.length;i++)(cel=document.createElement("TH")).innerHTML=cells[i],row.appendChild(cel)},telechargerStats:function(){if(""===qexport)return!1;var contentType,filename="resultats.csv",blob=new Blob([qexport],{type:"text/plain"});download(blob,filename,"text/plain")},traceColonne:function(x,h,hx,colors){var dxy=7;this.context.fillStyle=colors.face,this.context.strokeStyle=colors.face,this.context.fillRect(x,h-hx,30,hx),this.context.beginPath(),this.context.fillStyle=colors.right,this.context.moveTo(x+30,h),this.context.lineTo(x+30+7,h-7),this.context.lineTo(x+30+7,h-7-hx),this.context.lineTo(x+30,h-hx),this.context.closePath(),this.context.fill(),this.context.stroke(),this.context.fillStyle=colors.top,this.context.beginPath(),this.context.moveTo(x,h-hx),this.context.lineTo(x+30,h-hx),this.context.lineTo(x+30+7,h-hx-7),this.context.lineTo(x+7,h-hx-7),this.context.lineTo(x,h-hx),this.context.closePath(),this.context.fill(),this.context.stroke()}},camera={manualStopScan:!1,canvas:null,context:null,interval:null,video:null,videoReady:!1,videoSources:[],selectedSource:0,resol:1280,scanner:function(doIt){if(!camera.video)return!1;var start=!0;!1===doIt&&(start=!1),!0===scan&&void 0===doIt&&(start=!1),start?(QCMeditors.unloadCKEDITOR(),utils.montrerPasteUrl(!1),QCMeditors.toggleCacheQuestions(!0),document.getElementById("btna").src="css/img/32px/scan-marker-stop.png",users.afficheReponses(!1),utils.animeMenu("up"),utils.setChrono(),utils.startChrono()):(scan&&utils.animeMenu("down"),document.getElementById("btna").src="css/img/32px/scan-marker.png",this.canvas.style.opacity="0.5",clearInterval(camera.interval),answers.compteValeurs(),utils.intervalChrono&&(clearInterval(utils.intervalChrono),utils.intervalChrono=null))},tick:function(){if(!camera.video)return!1;var ok=!1;if(!0===QCMeditors.animation)return!1;if(4===camera.video.readyState){if(!1===camera.videoReady&&camera.video.videoWidth>0){camera.videoReady=!0,camera.canvas.width=parseInt(camera.video.videoWidth),camera.canvas.height=parseInt(camera.video.videoHeight),camera.canvas.style.width="320px";var hauteurImage=Math.round(320*parseInt(camera.video.videoHeight)/parseInt(camera.video.videoWidth));camera.canvas.style.height=hauteurImage+"px",document.getElementById("conteneureleves").style.marginTop=hauteurImage-110+"px",camera.videoSources.length>1&&(document.getElementById("btnchangecamera").className="",document.getElementById("btnportable").className="cache")}camera.canvas.width>0&&(camera.context.drawImage(camera.video,0,0,camera.canvas.width,camera.canvas.height),ok=!0)}if(scan&&ok){var imageData=camera.context.getImageData(0,0,camera.canvas.width,camera.canvas.height),markers=detector.detect(imageData);camera.drawMarkers(markers)}setTimeout(camera.tick,83)},drawMarkers:function(markers){var corners,corner,i,j,x,y,xmax,ymax;for(this.context.strokeStyle="red",this.context.textAlign="center",this.context.textBaseline="middle",i=0;i!==markers.length;++i){for(answers.affecte(corres[markers[i].id],camera.derterminateResponse(markers[i].corners)),corners=markers[i].corners,x=1/0,y=1/0,xmax=-1/0,ymax=-1/0,this.context.beginPath(),this.context.moveTo(corners[0].x,corners[0].y),this.context.lineWidth=3,this.context.fillStyle="rgba(0,0,5,0.6)",j=0;j<4;j++)corner=corners[(j+1)%4],this.context.lineTo(corner.x,corner.y),x=Math.min(x,corner.x),y=Math.min(y,corner.y),xmax=Math.max(xmax,corner.x),ymax=Math.max(ymax,corner.y);this.context.closePath(),this.context.stroke(),this.context.fill(),this.context.fillStyle="white",this.context.lineWidth=1,this.context.font=Math.max((ymax-y)/2)+"px Arial",void 0!==corres[markers[i].id]?this.context.fillText(corres[markers[i].id],(x+xmax)/2,(y+ymax)/2):this.context.fillText("# "+markers[i].id+" #",(x+xmax)/2,(y+ymax)/2)}answers.updateVotes()},start:function(){if(utils.setterFullHD(!1),0!==camera.videoSources.length){var videoSource=camera.videoSources[camera.selectedSource][0];if(camera.video)document.getElementById("conteneureleves").style.marginTop="",this.scanner(!1),camera.videoReady=!1,window.stream&&window.stream.getTracks().forEach((function(track){track.stop()})),camera.video.srcObject.active&&camera.video.srcObject.getTracks()[0].stop(),camera.video=null,camera.canvas.width=0,camera.canvas.height=0,camera.canvas.style.height=null,camera.canvas.style.width=null,camera.videoSources.length>1&&(document.getElementById("btnchangecamera").className="cache",document.getElementById("btnportable").className="");else{camera.video=document.getElementById("video"),window.stream&&window.stream.getTracks().forEach((function(track){track.stop()}));var constraints={video:{width:{min:640,ideal:camera.resol},deviceId:videoSource?{exact:videoSource}:void 0}};camera.video.onerror=function(){camera.videoSources.length>1&&(console.log("Erreur de lancement de la vidéo"),document.getElementById("btnchangecamera").className="",document.getElementById("btnportable").className="cache")},navigator.mediaDevices.getUserMedia(constraints).then((function(stream){return document.getElementById("cameras-list").className="cache",window.stream=stream,"srcObject"in camera.video?camera.video.srcObject=stream:camera.video.src=window.URL.createObjectURL(stream),camera.canvas.style.opacity="0.5",document.getElementById("commandeslive").className="",document.getElementById("editionQuestions").className="cache",document.getElementById("btng").style.opacity=1,QCMeditors.removeStyle(QCMeditors.qFocusOn),camera.tick(),navigator.mediaDevices.enumerateDevices()})).catch((function(err){console.log(err.name+": "+err.message),"NotFoundError"==err.name||"DevicesNotFoundError"==err.name||"NotReadableError"==err.name||"TrackStartError"==err.name||"OverconstrainedError"==err.name||"ConstraintNotSatisfiedError"==err.name||"NotAllowedError"==err.name||"PermissionDeniedError"==err.name||"TypeError"==err.name||err.name}))}}else this.detect()},handleError:function(error){console.log("navigator.getUserMedia error: ",error)},detect:function(){navigator.mediaDevices.enumerateDevices().then(camera.gotVideoDevices).catch(camera.handleError)},gotVideoDevices:function(deviceInfos){camera.videoSources=[];for(var i=0;i!==deviceInfos.length;++i){var deviceInfo=deviceInfos[i];if("videoinput"===deviceInfo.kind){var leLabel=deviceInfo.label||"camera "+(camera.videoSources.length+1);camera.videoSources.push([deviceInfo.deviceId,leLabel])}}var divcameras=document.getElementById("cameras-list");if(1===camera.videoSources.length)camera.selectedSource=0,divcameras.innerHTML=QCMCam.lang[lang].messages.onedetectedcam,divcameras.className="gris",utils.storageAvailable("localStorage")&&(localStorage.camera=camera.selectedSource);else if(0===camera.videoSources.length)divcameras.innerHTML=QCMCam.lang[lang].messages.nocamdetected,divcameras.className="yellow",utils.storageAvailable("localStorage")&&delete localStorage.camera;else for(void 0===localStorage.camera&&(camera.selectedSource=1),divcameras.className="gris",divcameras.innerHTML=QCMCam.lang[lang].messages.manycam,i=0;i<camera.videoSources.length;i++)divcameras.innerHTML+=" <input type='radio' name='cameraRadio' onClick='camera.selectedSource="+i+";' value='"+(i+1)+"' title='"+camera.videoSources[i][1]+"' "+(camera.selectedSource===i?"checked":"")+"> "+(i+1)},change:function(){if(1===camera.videoSources.length)return!1;this.start(),camera.videoSources.length>1&&(camera.selectedSource=(camera.selectedSource+1)%camera.videoSources.length),utils.storageAvailable("localStorage")&&(localStorage.camera=camera.selectedSource),this.start()},derterminateResponse:function(corners){var reponse,dx=corners[0].x-corners[2].x,dy=corners[0].y-corners[2].y;return dx>0?dy>0?reponse="C":dy<0&&(reponse="D"):dx<0&&(dy>0?reponse="B":dy<0&&(reponse="A")),reponse},determinateSize:function(vertex){var lcarre=vertex[0][0]*vertex[0][0]-vertex[1][0]*vertex[1][0]+vertex[0][1]*vertex[0][1]-vertex[1][1]*vertex[1][1],Lcarre=vertex[0][0]*vertex[0][0]-vertex[3][0]*vertex[3][0]+vertex[0][1]*vertex[0][1]-vertex[3][1]*vertex[3][1];return!(lcarre<100||Lcarre<100)}},comm={sessionId:null,interval:null,peer:null,peerId:!1,peerConnexion:null,intervalSession:null,httprelayChannel:null,cache:[],httprelayReceive:function(){var xhttp=new XMLHttpRequest;xhttp.onreadystatechange=function(){if(4==this.readyState&&200==this.status)var datas=JSON.parse(this.responseText)},xhttp.open("GET","http://httprelay.io/link/"+comm.httprelayChannel1,!0),xhttp.send()},httprelayPost:function(data){var xhttp=new XMLHttpRequest;xhttp.onreadystatechange=function(){4==this.readyState&&200==this.status&&this.responseText},xhttp.open("POST","http://httprelay.io/link/"+comm.httprelayChannel2,!0),http.setRequestHeader("Content-type","text/plain"),xhttp.send()},loadSession:function(){if(location.href.indexOf("file:")>-1)return alert("Fonctionnement immpossible sans serveur web."),!1;if(void 0===users.eleves.effectif)return alert(QCMCam.lang[lang].messages.groupneeded),!1;var rep;if(1===nbQ&&!confirm(QCMCam.lang[lang].messages.confirmbeforestart))return!1;null===comm.sessionId?usePeerJs?(comm.peer=new Peer,comm.peer.on("open",(function(id){comm.peerId=id,comm.showQRCode(comm.peerId),comm.peer.on("connection",(function(conn){document.getElementById("btnportable").className="cache",document.getElementById("btnstopportable").className="",comm.peerConnexion=conn,comm.peerConnexion.on("data",(function(data){if("paired"===data.connexion){document.getElementById("cameras-list").innerHTML=QCMCam.lang[lang].messages.connexionestablished;var datas=comm.initialDatas();"montre"===document.getElementById("qrious").className&&(document.getElementById("qrious").className="cache"),QCMeditors.toggleCacheQuestions(!0),comm.peerConnexion.send(datas)}comm.traiteJSON(data)}));var checkState=function(){var json=comm.updateState();answers.tests(!1),utils.isEmpty(json)||comm.peerConnexion.send(json)};comm.interval=setInterval(checkState,1633)}))})),comm.peer.on("error",(function(err){var infoBox;"browser-incompatible"===err?this.loadSessionPhp():document.getElementById("cameras-list").innerHTML="Erreur de connexion peerJS : "+err})),comm.peer.on("disconnected",(function(){var infoBox;document.getElementById("cameras-list").innerHTML=QCMCam.lang[lang].messages.deconnectionSmartphone,comm.interval&&clearInterval(comm.interval),!1!==comm.peerId&&(console.log("Déconnexion, tentative de reconnexion"),comm.peer.id=comm.peerId,comm.peer._lastServerId=comm.peerId,comm.peer.reconnect())})),comm.peer.on("close",(function(){comm.interval&&clearInterval(comm.interval),comm.peerId=!1,comm.peerConnexion=null,document.getElementById("cameras-list").innerHTML=QCMCam.lang[lang].messages.connexionclosed}))):this.loadSessionPhp():this.deporterScan()},loadSessionPhp:function(){var reader=new XMLHttpRequest;reader.onload=function(){var rep=JSON.parse(reader.responseText);if("failed"===rep.connexion)return document.getElementById("lienqr").innerHTML="<span class='text-red'>"+QCMCam.lang[lang].messages.connexionfailed+"</span>",!1;comm.sessionId=rep.id,document.getElementById("btnportable").className="cache",document.getElementById("btnstopportable").className="",comm.deporterScan()},reader.open("get","sessionapp.php",!0),reader.send()},deporterScan:function(){var datas=this.initialDatas(),reader=new XMLHttpRequest;reader.onload=function(){return!0},reader.open("get","sessionapp.php?s="+comm.sessionId+"&json="+JSON.stringify(datas),!0),reader.send(),this.showQRCode(),comm.sessionId&&!comm.intervalSession&&(comm.intervalSession=setTimeout(comm.getSessionData,2333))},showQRCode:function(peerId){void 0===peerId&&(peerId=!1),document.getElementById("qrious").className="montre",document.getElementById("qrious").setAttribute("onClick","window.open('app/index.html?"+(peerId?"p="+peerId:"s="+comm.sessionId)+"')","testsmartphone");var lieu=window.location.href,indexIndex=lieu.indexOf("index.html"),qr=new QRious({element:document.getElementById("qrious"),size:200,value:(indexIndex<0?lieu:lieu.substring(0,indexIndex))+"app/index.html?"+(peerId?"p="+peerId:"s="+comm.sessionId)})},initialDatas:function(){var ids={},reponses={};for(var i in users.eleves)"effectif"!==i&&(ids[i]=i,void 0!==datas[i]&&(reponses[i]=datas[i]));return{ids:ids,reps:qreponses,nbq:nbQ,qFocusOn:QCMeditors.qFocusOn,reponses:reponses}},stopSession:function(){!1!==comm.peerId?(comm.peerConnexion.send({commande:"stop"}),comm.peer.destroy()):stopSessionRequest=!0,document.getElementById("btnportable").className="",document.getElementById("btnstopportable").className="cache"},updateState:function(){var json={};if(usersChangeDetected){for(var i in json.ids={},users.eleves)"effectif"!==i&&(json.ids[i]=i);usersChangeDetected=!1,wait.updateClasse=!0}return changeQuestionFocus&&(json.qFocusOn=QCMeditors.qFocusOn,changeQuestionFocus=!1,"nexted"!==reponseAction&&(wait.nexted=!0)),changeNombreQuestions&&(json.nbq=nbQ,changeNombreQuestions=!1,wait.addQuestion=!0),reponsesChangeDetected&&(json.reps=qreponses,reponsesChangeDetected=!1),void 0!==reponseAction&&(json.ok=reponseAction,reponseAction=void 0),stopSessionRequest&&(json.stopSession=!0),json},getSessionData:function(){var json=comm.updateState(),reader=new XMLHttpRequest;reader.onload=function(){if(""!==reader.responseText)for(var lignesjson=reader.responseText.split("\n"),i=0;i<lignesjson.length;i++)""!==lignesjson[i]&&comm.traiteJSON(lignesjson[i]);if(stopSessionRequest)return stopSessionRequest=!1,void(comm.intervalSession=null);comm.intervalSession=setTimeout(comm.getSessionData,2333)},reader.open("get","sessionapp.php?s="+comm.sessionId+"&json="+JSON.stringify(json),!0),reader.send()},traiteJSON:function(json){"string"==typeof json&&(json=JSON.parse(json)),comm.peerConnexion&&comm.peerConnexion.send({received:json.date}),"received"===json.ok&&"montre"===document.getElementById("qrious").className&&(document.getElementById("qrious").className="cache",document.getElementById("lienqr").innerHTML=""),void 0!==json.nexted&&(wait.nexted=!1),void 0!==json.chgQuestion&&(wait.chgQuestion=!1),void 0!==json.updateClasse&&(wait.updateClasse=!1),(wait.nexted||wait.chgQuestion||wait.updateClasse)&&delete json.datas,this.setReponses(json)},setReponses:function(lesDatas){var dataUpdated=!1,alreadyReceived=!1,now=Date.now();for(var i in lesDatas.dataR)void 0!==lesDatas.dataR[i]&&""!==lesDatas.dataR[i]&&(void 0===datas[Number(i)]&&(datas[Number(i)]=reponseSimple?{vote:"",nbvotes:0}:{vote:[],nbvotes:0}),datas[Number(i)].vues=answers.vuesMin+5,answers.affecte(Number(i),lesDatas.dataR[i]),dataUpdated=!0);if(dataUpdated&&(answers.updateVotes(),answers.compteValeurs()),void 0!==lesDatas.action)if(void 0!==lesDatas.date&&(comm.cache.indexOf(lesDatas.date)>-1?alreadyReceived=!0:comm.cache.push(lesDatas.date)),"startscan"===lesDatas.action)QCMeditors.toggleCacheQuestions(!0),reponseAction="scanstarted";else{if("end"===lesDatas.action)return reponseAction="ended",!0;if("next"===lesDatas.action)alreadyReceived||(QCMeditors.nextQ(),users.afficheReponses(!1)),reponseAction="nexted";else if("stats"===lesDatas.action)alreadyReceived||users.afficheReponses(),reponseAction="statsed";else if("correct"===lesDatas.action)alreadyReceived||answers.giveGoodAnswer(),reponseAction="corrected";else if("reset"===lesDatas.action)alreadyReceived||answers.initAll(!1),reponseAction="reseted";else if(lesDatas.action.indexOf("alea")>-1){var what=lesDatas.action.substring(4),trueFalse;"true"===what?trueFalse=!0:"false"===what&&(trueFalse=!1),alreadyReceived||users.alea(trueFalse),reponseAction="aleaed"}else(["A","B","C","D"].indexOf(lesDatas.action)>-1||Array.isArray(lesDatas.action))&&answers.setGoodAnswer(lesDatas.action,!1)}}};class groupe{constructor(liste){this.liste=liste,this.isoles={},this.effectif=liste.effectif,this.roles=[],this.ignore=0,this.nbpergroup=4,this.nbgroups=this.calcnbgroups(4),this.editedValue="nbpergroup",this.checkAllRoles(!1)}checkAllRoles(bool){let listeRoles=["time","speak","ideas","calm","instr","material","all"];this.roles=bool?["T","P","I","S","C","M"]:[];for(let i=0,len=listeRoles.length;i<len;i++)document.getElementById("resp-"+listeRoles[i]).checked=bool}show(){""===document.getElementById("initial-group").className?(document.getElementById("initial-group").className="cache",document.getElementById("isolated-users").className="cache"):(document.getElementById("initial-group").className="",document.getElementById("isolated-users").className="")}showScore(){let spans=document.querySelectorAll("#group-manager span[data-score='1']"),classname="cache";if(spans.length){"cache"===spans[0].className&&(classname="");for(let i=0,len=spans.length;i<len;i++)spans[i].className=classname}}display(){let initial=document.getElementById("initial-group");initial.innerHTML="";let isolated=document.getElementById("isolated-users");isolated.innerHTML="",this.effectif=0,this.ignore=0,this.ids=[];for(let i in this.liste)isNaN(i)||(void 0===this.isoles[i]?(this.ids.push(i),initial.appendChild(this.createDomElement(i,"out")),this.effectif++):(isolated.appendChild(this.createDomElement(i,"in")),this.ignore++));document.getElementById("repartir").innerHTML=this.effectif,document.getElementById("ignorer").innerHTML=this.ignore,"nbpergroup"===this.editedValue?this.calcnbgroups(this.nbpergroup):this.calcnbpergroup(this.nbgroups)}createDomElement(userId,action){let div=document.createElement("div");div.className="groupUser",div.dataset.id=userId;let span=document.createElement("span");if(span.innerHTML=userId,span.className="numero",div.appendChild(span),div.appendChild(document.createTextNode(this.liste[userId])),!isNaN(answers.scores[userId])){let span=document.createElement("span");span.className="cache",span.dataset.score="1",span.innerHTML="("+answers.scores[userId]+")",div.appendChild(span)}if("out"===action)div.addEventListener("click",(function(evt){users.workgroup.isolate(this.dataset.id)}));else if("in"===action)div.addEventListener("click",(function(evt){users.workgroup.unisolate(this.dataset.id)}));else if(""!==action){let associtions={T:"bleu",P:"violet",I:"orange",S:"vert",C:"rouge",M:"azur"};for(let i=0,len=action.length;i<len;i++){let span=document.createElement("span");span.className=associtions[action[i]],span.textContent=action[i],div.appendChild(span)}}return div}isolate(id){this.isoles[id]=this.liste[id],this.display()}unisolate(id){delete this.isoles[id],this.display()}calcnbgroups(value){this.editedValue="nbpergroup",this.nbpergroup=value,this.nbgroups=Math.ceil(this.effectif/value),document.getElementById("nb-groups").value=this.nbgroups}calcnbpergroup(value){this.editedValue="nbgroups",this.nbgroups=value,this.nbpergroup=Math.ceil(this.effectif/value),document.getElementById("nb-per-group").value=this.nbpergroup}setRole(value,bool){bool?this.roles.push(value):this.roles.splice(this.roles.indexOf(value),1)}alea(){this.ids=utils.shuffle(this.ids),this.groups=[];for(let i=0;i<this.nbgroups;i++)this.groups.push([]);for(let i=0,len=this.ids.length;i<len;i++){const j=i%this.nbgroups;this.groups[j].push(this.ids[i])}this.displayGroups()}hetero(){if(utils.isEmpty(qdatas))return alert("Pas de score pour répartir les élèves"),!1;{let tables={},values=[];for(let i in answers.scores){if(isNaN(answers.scores[i])||this.ids.indexOf(i)<0)continue;let score=answers.scores[i];void 0===tables[score]&&(tables[score]=[],values.push(score)),tables[score].push(i)}values.sort(),this.ids=[];for(let i=0;i<values.length;i++)tables[values[i]]=utils.shuffle(tables[values[i]]),this.ids=this.ids.concat(tables[values[i]]);this.groups=[];for(let i=0;i<this.nbgroups;i++)this.groups.push([]);for(let i=0,len=this.ids.length;i<len;i++){const j=i%this.nbgroups;this.groups[j].push(this.ids[i])}this.displayGroups()}}homo(){if(utils.isEmpty(qdatas))return alert("Pas de score pour répartir les élèves"),!1;{let tables={},values=[];for(let i in answers.scores){if(isNaN(answers.scores[i])||this.ids.indexOf(i)<0)continue;let score=answers.scores[i];void 0===tables[score]&&(tables[score]=[],values.push(score)),tables[score].push(i)}values.sort(),this.ids=[];for(let i=0;i<values.length;i++)tables[values[i]]=utils.shuffle(tables[values[i]]),this.ids=this.ids.concat(tables[values[i]]);this.groups=[];for(let i=0;i<this.nbgroups;i++)this.groups.push([]);for(let i=0,len=this.ids.length;i<len;i++){const j=Math.floor(i/this.nbpergroup);this.groups[j].push(this.ids[i])}this.displayGroups()}}displayGroups(){let dest=document.getElementById("resulted-groups");dest.innerHTML="";for(let i=0,len=this.groups.length;i<len;i++){let fieldset=document.createElement("fieldset"),legend=document.createElement("legend");legend.innerHTML="Groupe "+(i+1),fieldset.appendChild(legend);for(let j=0,len2=this.groups[i].length;j<len2;j++)fieldset.appendChild(this.createDomElement(this.groups[i][j],this.giveRole(j,len2)));dest.appendChild(fieldset)}}createOneGroup(eff){if(!isNaN(eff)){this.ids=utils.shuffle(this.ids),this.groups=[[]];for(let i=0;i<eff;i++)this.groups[0].push(this.ids[i]);this.displayGroups()}}emptyGroups(){this.groups=[],this.displayGroups()}giveRole(index,taille){let nbRoles=this.roles.length;if(taille>=nbRoles)return void 0!==this.roles[index]?this.roles[index]:"";{let chaine="";for(let i=index;i<nbRoles;i+=taille)chaine+=this.roles[i];return chaine}}}function onLoad(){let timestamps={182:0,183:0};function preventDouble(code){let now=Date.now();return!(timestamps[code]>now-300)&&(timestamps[code]=now,182===code?(answers.giveGoodAnswer(),!1):183===code?(users.afficheReponses(),!1):void 0)}if(document.getElementById("temps").value="00:00",(liendirect=location.href.indexOf("?"))>0){var paramsLien=utils.getUrlVars();void 0!==paramsLien.lang&&(lang=paramsLien.lang,QCMCam.lang.translate()),void 0!==paramsLien.url&&QCMeditors.loadFile(location.href.substring(location.href.indexOf("url=")+4))}else utils.storageAvailable("localStorage")&&void 0!==localStorage.lastQ&&"{}"!==localStorage.lastQ&&utils.class("btnrq","");utils.storageAvailable("localStorage")&&localStorage.camera>-1&&(camera.selectedSource=localStorage.camera),location.href.indexOf("file:")>-1&&(document.getElementById("btnportable").className="cache"),users.firstImport(),void 0===navigator.mediaDevices.getUserMedia&&(navigator.mediaDevices.getUserMedia=function(constraints){var getUserMedia=navigator.webkitGetUserMedia||navigator.mozGetUserMedia;return getUserMedia?new Promise((function(resolve,reject){getUserMedia.call(navigator,constraints,resolve,reject)})):Promise.reject(new Error("getUserMedia is not implemented in this browser"))}),camera.detect(),detector=new AR.Detector,camera.canvas=document.getElementById("surcouche"),camera.context=camera.canvas.getContext("2d"),answers.canvas=document.getElementById("colonnes"),answers.contextInit(),liendirect<0&&"fr"!==lang&&QCMCam.lang.translate(),liendirect<0&&QCMeditors.loadCKEDITOR(),setTimeout(utils.lancerReveal,1e3),document.onkeydown=function(evt){if(evt=evt||window.event,!1===QCMeditors.editable){switch(evt.key){case"Up":case"ArrowUp":QCMeditors.nextQ();break;case"Down":case"ArrowDown":QCMeditors.prevQ();break;case"Left":case"ArrowLeft":QCMeditors.prevQ();break;case"Right":case"ArrowRight":QCMeditors.nextQ();break;case"PageDown":QCMeditors.prevQ();break;case"PageUp":QCMeditors.nextQ();break;case"Period":users.afficheReponses();break;case"Esc":case"Escape":case"Tab":camera.scanner();break;case"AudioVolumeUp":preventDouble(183);break;case"AudioVolumeDown":preventDouble(182);break;case"F6":camera.scanner()}evt.preventDefault()}if(evt.altKey)switch(evt.key){case"k":users.alea();break;case"s":camera.start();break;case"i":utils.Infos("open");break;case"z":utils.pleinEcran();break;case"g":QCMeditors.nextQ();break;case"c":camera.scanner();break;case"v":users.afficheReponses();break;case"r":answers.initAll();break;case"x":QCMeditors.addQ()}},document.onkeyup=function(evt){if("$"===evt.key){var editor=CKEDITOR.instances["editor"+QCMeditors.qFocusOn],content=editor.getData();content.split("$$").length-1==2&&(content=content.replace(/\$\$([^$]*)\$\$/i,'<span class="math-tex" data-tex="$1">$1</span> <span id="bukmrk">.</span>'),editor.setData(content,(function(){var element=editor.document.getById("bukmrk"),selection=editor.getSelection(),range;selection.selectElement(element),selection.getRanges()[0].select(),element.remove()})))}}}window.onload=onLoad;